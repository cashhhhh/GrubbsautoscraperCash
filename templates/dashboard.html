<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grubbs INFINITI — Marketplace Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            sidebar: '#08111F',
            'sidebar-hover': '#0f2038',
            fb: '#1877F2',
            'fb-dark': '#0d5fcf',
          },
          fontFamily: { sans: ['Inter','system-ui','sans-serif'] },
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    [x-cloak]{display:none!important}
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:#f1f5f9}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:#94a3b8}
    /* Nav items — raw CSS so custom theme colors resolve at all times */
    .nav-item{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-radius:.75rem;color:#cbd5e1;font-size:.875rem;font-weight:500;transition:all 150ms;cursor:pointer;user-select:none}
    .nav-item:hover{background:rgba(255,255,255,.1);color:#fff}
    .nav-item.active{background:rgba(24,119,242,.15);color:#1877F2;font-weight:600;box-shadow:inset 0 0 0 1px rgba(24,119,242,.25)}
    .stat-card{@apply bg-white rounded-2xl p-5 shadow-sm border border-slate-100 transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md}
    .badge{@apply inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold}
    /* Buttons — raw CSS to avoid @apply chaining issues with custom colors */
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;border-radius:.5rem;font-size:.875rem;font-weight:600;transition:all 150ms}
    .btn-primary{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;border-radius:.5rem;font-size:.875rem;font-weight:600;transition:all 150ms;background:#1877F2;color:#fff;box-shadow:0 1px 2px rgba(0,0,0,.08)}
    .btn-primary:hover:not(:disabled){background:#0d5fcf}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}
    .btn-ghost{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;border-radius:.5rem;font-size:.875rem;font-weight:600;transition:all 150ms;background:#fff;border:1px solid #e2e8f0;color:#334155}
    .btn-ghost:hover:not(:disabled){background:#f8fafc}
    .btn-ghost:disabled{opacity:.5;cursor:not-allowed}
    .pulse-dot{@apply h-2 w-2 rounded-full}
    @keyframes spin-slow{to{transform:rotate(360deg)}}
    .spin-slow{animation:spin-slow 2s linear infinite}
  </style>
</head>

<body class="h-full bg-slate-100 font-sans text-slate-800"
  x-data="dashboard()"
  x-init="init()"
  x-cloak>

<!-- ════════════════════════════════════════════════════════════════════════ -->
<!--  LAYOUT SHELL                                                           -->
<!-- ════════════════════════════════════════════════════════════════════════ -->
<div class="flex h-full min-h-screen">

  <!-- ── SIDEBAR ─────────────────────────────────────────────────────────── -->
  <aside class="w-60 shrink-0 bg-sidebar flex flex-col fixed inset-y-0 z-30 shadow-xl">

    <!-- Logo -->
    <div class="px-5 pt-6 pb-4 border-b border-white/10">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 bg-fb rounded-xl flex items-center justify-center shadow">
          <!-- FB icon -->
          <svg class="w-5 h-5 text-white fill-current" viewBox="0 0 24 24"><path d="M24 12.073C24 5.405 18.627 0 12 0S0 5.405 0 12.073C0 18.1 4.388 23.094 10.125 24v-8.437H7.078v-3.49h3.047V9.41c0-3.025 1.791-4.697 4.533-4.697 1.312 0 2.686.236 2.686.236v2.97h-1.513c-1.491 0-1.956.93-1.956 1.887v2.267h3.328l-.532 3.49h-2.796V24C19.612 23.094 24 18.1 24 12.073z"/></svg>
        </div>
        <div>
          <p class="text-white text-sm font-bold leading-tight">Grubbs INFINITI</p>
          <p class="text-slate-400 text-xs">San Antonio</p>
        </div>
      </div>
    </div>

    <!-- Nav -->
    <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
      <p class="text-slate-500 text-xs font-semibold uppercase tracking-wider px-4 mb-2">Menu</p>
      <div class="nav-item" :class="tab==='inventory'&&'active'" @click="tab='inventory'">
        <svg class="w-4 h-4 shrink-0 fill-current" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 6a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zm0 6a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z"/></svg>
        Inventory
      </div>
      <div class="nav-item" :class="tab==='analytics'&&'active'" @click="tab='analytics'">
        <svg class="w-4 h-4 shrink-0 fill-current" viewBox="0 0 20 20"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zm6-4a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zm6-3a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/></svg>
        Analytics
      </div>
      <div class="nav-item" :class="tab==='history'&&'active'" @click="tab='history'">
        <svg class="w-4 h-4 shrink-0 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
        Sync History
      </div>
      <div class="nav-item" :class="tab==='deal_history'&&'active'" @click="tab='deal_history';loadDealHistory()">
        <svg class="w-4 h-4 shrink-0 fill-current" viewBox="0 0 20 20"><path d="M4 3a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V7.414a1 1 0 00-.293-.707l-3.414-3.414A1 1 0 0012.586 3H4zm7 1.414L15.586 9H11V4.414z"/></svg>
        Deal History
      </div>
      <div class="nav-item" :class="tab==='lot_walk'&&'active'" @click="tab='lot_walk'">
        <svg class="w-4 h-4 shrink-0 fill-current" viewBox="0 0 20 20"><path d="M10 2a4 4 0 00-4 4v3H5a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2h-1V6a4 4 0 00-4-4zm2 7V6a2 2 0 10-4 0v3h4z"/></svg>
        Lot Walk
      </div>

      <!-- Admin: Users -->
      <div x-show="isAdmin" class="nav-item" :class="tab==='users'&&'active'" @click="tab='users';loadUsers()">
        <svg class="w-4 h-4 shrink-0 fill-current" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/></svg>
        Users
      </div>

      <!-- Deals history -->
      <div class="nav-item" :class="tab==='deals'&&'active'" @click="tab='deals';loadDeals()">
        <svg class="w-4 h-4 shrink-0 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/></svg>
        Deal History
      </div>

      <!-- Lot Walk -->
      <div class="nav-item" :class="tab==='walk'&&'active'" @click="tab='walk'">
        <svg class="w-4 h-4 shrink-0 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg>
        Lot Walk
      </div>

      <div class="my-3 border-t border-white/10"></div>
      <div class="px-3 space-y-2">
        <!-- Sync Now -->
        <button
          class="w-full flex items-center gap-2.5 px-4 py-2.5 rounded-xl font-semibold text-sm transition-all select-none
                 bg-emerald-500 hover:bg-emerald-400 text-white shadow-lg shadow-emerald-900/30
                 disabled:opacity-50 disabled:cursor-not-allowed"
          :disabled="syncRunning"
          @click="triggerSync()">
          <svg class="w-4 h-4 shrink-0 fill-current" :class="syncRunning&&'spin-slow'" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
          </svg>
          <span x-text="syncRunning ? 'Syncing…' : 'Sync Now'"></span>
        </button>

        <!-- Refresh FB Stats -->
        <button
          class="w-full flex items-center gap-2.5 px-4 py-2.5 rounded-xl font-semibold text-sm transition-all select-none
                 bg-indigo-500 hover:bg-indigo-400 text-white shadow-lg shadow-indigo-900/30
                 disabled:opacity-50 disabled:cursor-not-allowed"
          :disabled="statsRunning"
          @click="refreshStats()">
          <svg class="w-4 h-4 shrink-0 fill-current" :class="statsRunning&&'spin-slow'" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
          <span x-text="statsRunning ? 'Fetching…' : 'Refresh FB Stats'"></span>
        </button>
      </div>
    </nav>

    <!-- Bottom status + settings gear -->
    <div class="p-4 border-t border-white/10 space-y-2">
      <div class="text-xs text-slate-500 space-y-1">
        <div class="flex items-center gap-2">
          <span class="pulse-dot" :class="summary.last_sync_ok ? 'bg-emerald-400' : 'bg-red-400'"></span>
          <span x-text="summary.last_sync_at ? 'Last sync: ' + fmtDate(summary.last_sync_at) : 'No syncs yet'"></span>
        </div>
        <div x-show="summary.addendum_amount > 0" class="text-amber-400 font-semibold">
          Addendum: $<span x-text="fmt(summary.addendum_amount)"></span>
        </div>
      </div>
      <!-- Settings button -->
      <button class="flex items-center gap-2 w-full px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-sidebar-hover text-xs font-medium transition-all"
        @click="settingsOpen=true">
        <svg class="w-4 h-4 fill-current shrink-0" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg>
        Settings
      </button>

      <!-- Signed-in user + Logout -->
      <div class="flex items-center justify-between px-3 py-2 rounded-lg bg-white/5">
        <div class="flex items-center gap-2 min-w-0">
          <div class="w-6 h-6 rounded-full bg-fb/20 flex items-center justify-center shrink-0">
            <span class="text-fb text-xs font-bold" x-text="currentUser.slice(0,1).toUpperCase()"></span>
          </div>
          <span class="text-slate-300 text-xs font-medium truncate" x-text="currentUser"></span>
          <span x-show="isAdmin" class="text-xs px-1.5 py-0.5 rounded bg-fb/20 text-fb font-semibold leading-none">Admin</span>
        </div>
        <button @click="logout()" title="Sign out"
          class="text-slate-500 hover:text-red-400 transition-colors ml-1 shrink-0">
          <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h7a1 1 0 100-2H4V5h6a1 1 0 100-2H3zm11.293 4.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L15.586 12H9a1 1 0 110-2h6.586l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
        </button>
      </div>
    </div>
  </aside>

  <!-- ── MAIN ────────────────────────────────────────────────────────────── -->
  <main class="flex-1 ml-60 flex flex-col min-h-screen">

    <!-- Top bar -->
    <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200 px-8 py-3 flex items-center justify-between">
      <div>
        <h1 class="text-base font-bold text-slate-900" x-text="tabLabel()"></h1>
        <p class="text-xs text-slate-500" x-text="summary.total_active + ' vehicles active · stats as of ' + (summary.stats_date || 'never')"></p>
      </div>
      <div class="flex items-center gap-3">
        <!-- Status pill -->
        <template x-if="statusMsg">
          <span class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600" x-text="statusMsg"></span>
        </template>
        <span class="text-xs text-slate-400" x-text="'Updated ' + lastRefreshed"></span>
        <button class="btn-ghost text-xs" @click="reload()">
          <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/></svg>
          Refresh
        </button>
        <button class="btn-ghost text-xs" @click="sendWeeklyDigest()">Weekly Digest</button>
      </div>
    </header>

    <div class="flex-1 p-8 space-y-6 overflow-x-hidden">

      <div class="flex flex-wrap items-center gap-2">
        <button class="text-xs px-3 py-1.5 rounded-lg border" :class="tab==='inventory' ? 'bg-fb text-white border-fb' : 'bg-white border-slate-200 text-slate-600'" @click="tab='inventory'">Inventory</button>
        <button class="text-xs px-3 py-1.5 rounded-lg border" :class="tab==='analytics' ? 'bg-fb text-white border-fb' : 'bg-white border-slate-200 text-slate-600'" @click="tab='analytics'">Analytics</button>
        <button class="text-xs px-3 py-1.5 rounded-lg border" :class="tab==='history' ? 'bg-fb text-white border-fb' : 'bg-white border-slate-200 text-slate-600'" @click="tab='history'">Sync History</button>
        <button class="text-xs px-3 py-1.5 rounded-lg border" :class="tab==='deal_history' ? 'bg-fb text-white border-fb' : 'bg-white border-slate-200 text-slate-600'" @click="tab='deal_history';loadDealHistory()">Deal History</button>
        <button x-show="isAdmin" class="text-xs px-3 py-1.5 rounded-lg border" :class="tab==='users' ? 'bg-fb text-white border-fb' : 'bg-white border-slate-200 text-slate-600'" @click="tab='users';loadUsers()">Users</button>
      </div>

      <!-- ══ STAT CARDS ═════════════════════════════════════════════════════ -->
      <div class="grid grid-cols-2 xl:grid-cols-4 gap-4">

        <!-- Active Listings -->
        <div class="stat-card">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Active Listings</p>
              <p class="text-3xl font-extrabold text-slate-900 mt-1" x-text="summary.total_active ?? '—'"></p>
              <p class="text-xs text-slate-400 mt-1">
                <span class="text-emerald-600 font-semibold" x-text="summary.total_priced"></span> priced ·
                <span class="text-amber-600 font-semibold" x-text="summary.total_no_price"></span> missing price
              </p>
            </div>
            <div class="w-10 h-10 bg-fb/10 rounded-xl flex items-center justify-center">
              <svg class="w-5 h-5 text-fb fill-current" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/></svg>
            </div>
          </div>
        </div>

        <!-- Avg Price w/ Addendum -->
        <div class="stat-card">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Avg Price</p>
              <p class="text-3xl font-extrabold text-slate-900 mt-1">$<span x-text="fmt(summary.avg_price)"></span></p>
              <p class="text-xs text-slate-400 mt-1" x-show="summary.addendum_amount > 0">
                w/ addendum: <span class="text-amber-600 font-semibold">$<span x-text="fmt(summary.avg_price_with_addendum)"></span></span>
              </p>
              <p class="text-xs text-slate-400 mt-1" x-show="!summary.addendum_amount">internet price avg</p>
            </div>
            <div class="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center">
              <svg class="w-5 h-5 text-emerald-500 fill-current" viewBox="0 0 20 20"><path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.028 2.353 1.118V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.028-2.354-1.118V5z" clip-rule="evenodd"/></svg>
            </div>
          </div>
        </div>

        <!-- FB Clicks -->
        <div class="stat-card">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">FB Clicks</p>
              <p class="text-3xl font-extrabold text-slate-900 mt-1" x-text="summary.total_clicks ?? '—'"></p>
              <p class="text-xs text-slate-400 mt-1">
                <span class="text-slate-600 font-semibold" x-text="summary.total_saves"></span> saves ·
                <span x-text="summary.stats_date ? 'as of ' + summary.stats_date : 'no data yet'"></span>
              </p>
            </div>
            <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center">
              <svg class="w-5 h-5 text-fb fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6.672 1.911a1 1 0 10-1.932.518l.259.966a1 1 0 001.932-.518l-.26-.966zM2.429 4.74a1 1 0 10-.517 1.932l.966.259a1 1 0 00.517-1.932l-.966-.26zm8.814-.569a1 1 0 00-1.415-1.414l-.707.707a1 1 0 101.415 1.415l.707-.708zm-7.071 7.072l.707-.707A1 1 0 003.465 9.12l-.708.707a1 1 0 001.415 1.415zm3.2-5.171a1 1 0 00-1.3 1.3l4 10a1 1 0 001.823.075l1.38-2.759 3.018 3.02a1 1 0 001.414-1.415l-3.019-3.02 2.76-1.379a1 1 0 00-.076-1.822l-10-4z" clip-rule="evenodd"/></svg>
            </div>
          </div>
        </div>

        <!-- FB Impressions -->
        <div class="stat-card">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Impressions</p>
              <p class="text-3xl font-extrabold text-slate-900 mt-1" x-text="fmtBig(summary.total_impressions)"></p>
              <p class="text-xs text-slate-400 mt-1">
                CTR: <span class="font-semibold text-slate-600" x-text="ctr()"></span>
              </p>
            </div>
            <div class="w-10 h-10 bg-violet-50 rounded-xl flex items-center justify-center">
              <svg class="w-5 h-5 text-violet-500 fill-current" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg>
            </div>
          </div>
        </div>
      </div>

      <!-- ══ INVENTORY TAB ══════════════════════════════════════════════════ -->
      <div x-show="tab==='inventory'" x-cloak>

        <!-- Filters -->
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-4 flex flex-wrap gap-3 items-end">
          <!-- Search -->
          <div class="flex-1 min-w-48">
            <label class="block text-xs font-semibold text-slate-500 mb-1">Search</label>
            <div class="relative">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
              <input x-model="filters.search" @input.debounce.400ms="loadVehicles()"
                placeholder="VIN, stock #, model…"
                class="w-full pl-9 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb" />
            </div>
          </div>
          <!-- Make -->
          <div class="min-w-36">
            <label class="block text-xs font-semibold text-slate-500 mb-1">Make</label>
            <select x-model="filters.make" @change="loadVehicles()"
              class="w-full py-2 px-3 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb">
              <option value="">All Makes</option>
              <template x-for="m in makes" :key="m">
                <option :value="m" x-text="m"></option>
              </template>
            </select>
          </div>
          <!-- Year -->
          <div class="min-w-28">
            <label class="block text-xs font-semibold text-slate-500 mb-1">Year</label>
            <select x-model="filters.year" @change="loadVehicles()"
              class="w-full py-2 px-3 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb">
              <option value="">All Years</option>
              <template x-for="y in years" :key="y">
                <option :value="y" x-text="y"></option>
              </template>
            </select>
          </div>
          <!-- Condition -->
          <div class="min-w-32">
            <label class="block text-xs font-semibold text-slate-500 mb-1">Condition</label>
            <select x-model="filters.condition" @change="loadVehicles()"
              class="w-full py-2 px-3 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb">
              <option value="">All</option>
              <option value="used">Used</option>
              <option value="new">New</option>
            </select>
          </div>
          <!-- Body Style -->
          <div class="min-w-36">
            <label class="block text-xs font-semibold text-slate-500 mb-1">Body Style</label>
            <select x-model="filters.body_style" @change="loadVehicles()"
              class="w-full py-2 px-3 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb">
              <option value="">All Styles</option>
              <template x-for="bs in bodyStyles" :key="bs">
                <option :value="bs" x-text="bs"></option>
              </template>
            </select>
          </div>
          <!-- 3-Row SUV toggle -->
          <div class="flex items-end">
            <button
              @click="filters.three_row = !filters.three_row; loadVehicles()"
              class="flex items-center gap-1.5 px-3 py-2 text-xs font-semibold border rounded-lg transition-all select-none"
              :class="filters.three_row ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'">
              <svg class="w-3.5 h-3.5 fill-current shrink-0" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 5a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V9zm0 5a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z"/></svg>
              3-Row SUVs
            </button>
          </div>
          <!-- Clear -->
          <button class="btn-ghost text-xs" @click="clearFilters()">Clear</button>
          <!-- Count -->
          <span class="text-xs text-slate-400 ml-auto self-center" x-text="vehicles.length + ' results'"></span>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
          <!-- Loading skeleton -->
          <div x-show="loading" class="p-8 text-center text-slate-400 text-sm animate-pulse">Loading inventory…</div>

          <div x-show="!loading" class="table-container">
            <table class="w-full text-sm">
              <thead>
                <tr class="bg-slate-50 border-b border-slate-100">
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider w-16">Photo</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vehicle</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Stock / VIN</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Style</th>
                  <th class="px-3 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Mileage</th>
                  <th class="px-3 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Internet Price</th>
                  <th class="px-3 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">w/ Addendum</th>
                  <th class="px-3 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">% Market</th>
                  <th class="px-3 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">FB Clicks</th>
                  <th class="px-3 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Impressions</th>
                  <th class="px-3 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Saves</th>
                  <th class="px-3 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Links</th>
                  <th class="px-3 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Mock Pencil</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-50">
                <template x-if="vehicles.length === 0">
                  <tr><td colspan="14" class="py-12 text-center text-slate-400 text-sm">No vehicles match your filters.</td></tr>
                </template>
                <template x-for="v in vehicles" :key="v.vin">
                  <tr class="transition-colors cursor-default group"
                      :class="v.days_on_lot >= 60 ? 'bg-red-50/40 hover:bg-red-50' : v.days_on_lot >= 30 ? 'bg-amber-50/40 hover:bg-amber-50' : 'hover:bg-blue-50/40'"
                      @click="openModal(v)">
                    <!-- Thumb -->
                    <td class="px-3 py-2.5">
                      <div class="w-14 h-10 rounded-lg overflow-hidden bg-slate-100 shrink-0">
                        <img x-show="v.image_url" :src="v.image_url" :alt="v.title"
                          class="w-full h-full object-cover"
                          @error="$el.style.display='none'" loading="lazy" />
                      </div>
                    </td>
                    <!-- Vehicle -->
                    <td class="px-3 py-2.5">
                      <p class="font-semibold text-slate-900 text-xs leading-tight" x-text="v.year + ' ' + v.make + ' ' + v.model"></p>
                      <p class="text-slate-400 text-xs leading-tight" x-text="v.trim || '—'"></p>
                      <p class="text-slate-400 text-xs leading-tight" x-text="v.exterior_color || ''"></p>
                      <div class="mt-1 flex flex-wrap gap-1">
                        <span class="badge" :class="v.days_on_lot >= 60 ? 'bg-red-100 text-red-700' : v.days_on_lot >= 30 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'" x-text="'DOL ' + (v.days_on_lot || 0)"></span>
                        <span x-show="v.price_war_alert" class="badge bg-red-100 text-red-700">⚠ Price war</span>
                      </div>
                    </td>
                    <!-- Stock / VIN -->
                    <td class="px-3 py-2.5">
                      <p class="font-mono text-xs text-slate-700" x-text="v.stock_number || '—'"></p>
                      <p class="font-mono text-xs text-slate-400" x-text="v.vin"></p>
                    </td>
                    <!-- Body Style -->
                    <td class="px-3 py-2.5">
                      <span class="badge"
                        :class="bodyBadge(v.body_style)"
                        x-text="v.body_style || '?'"></span>
                      <p class="text-xs text-slate-400 mt-0.5" x-text="v.condition"></p>
                    </td>
                    <!-- Mileage -->
                    <td class="px-3 py-2.5 text-right font-mono text-xs text-slate-700" x-text="v.mileage ? fmt(v.mileage) + ' mi' : '—'"></td>
                    <!-- Internet Price -->
                    <td class="px-3 py-2.5 text-right">
                      <template x-if="v.price_ok">
                        <div>
                          <span class="font-bold text-emerald-700 text-sm">$<span x-text="fmt(v.effective_price)"></span></span>
                          <template x-if="priceWars[v.vin]">
                            <span class="block badge bg-red-100 text-red-600 mt-0.5">⚠ Price War</span>
                          </template>
                          <template x-if="v.price_overridden">
                            <span class="block badge bg-amber-100 text-amber-700 mt-0.5">Edited</span>
                          </template>
                        </div>
                      </template>
                      <template x-if="!v.price_ok">
                        <span class="badge bg-red-100 text-red-700">No Price</span>
                      </template>
                    </td>
                    <!-- w/ Addendum -->
                    <td class="px-3 py-2.5 text-right">
                      <template x-if="v.price_with_addendum && v.effective_addendum > 0">
                        <div>
                          <span class="font-bold text-amber-700 text-sm">$<span x-text="fmt(v.price_with_addendum)"></span></span>
                          <p class="text-xs text-amber-500">+$<span x-text="fmt(v.effective_addendum)"></span></p>
                        </div>
                      </template>
                      <template x-if="!v.effective_addendum || v.effective_addendum === 0">
                        <span class="text-xs text-slate-300">—</span>
                      </template>
                      <template x-if="v.effective_addendum > 0 && !v.price_with_addendum">
                        <span class="text-xs text-slate-300">—</span>
                      </template>
                    </td>
                    <!-- % to Market -->
                    <td class="px-3 py-2.5 text-center">
                      <template x-if="v.pct_to_market !== null && v.pct_to_market !== undefined">
                        <span class="badge font-mono"
                          :class="v.pct_to_market > 5 ? 'bg-red-100 text-red-700' : v.pct_to_market < -5 ? 'bg-emerald-100 text-emerald-700' : 'bg-yellow-100 text-yellow-700'"
                          x-text="(v.pct_to_market > 0 ? '+' : '') + v.pct_to_market.toFixed(1) + '%'"></span>
                      </template>
                      <template x-if="v.pct_to_market === null || v.pct_to_market === undefined">
                        <button class="text-xs text-slate-300 hover:text-fb transition-colors" @click.stop="openModal(v,'edit')">Set&nbsp;MV</button>
                      </template>
                    </td>
                    <!-- Clicks -->
                    <td class="px-3 py-2.5 text-center">
                      <span class="font-semibold text-fb text-sm" x-text="v.fb_clicks"></span>
                    </td>
                    <!-- Impressions -->
                    <td class="px-3 py-2.5 text-center">
                      <span class="font-semibold text-violet-600 text-sm" x-text="fmtBig(v.fb_impressions)"></span>
                    </td>
                    <!-- Saves -->
                    <td class="px-3 py-2.5 text-center">
                      <span class="text-slate-600 text-sm" x-text="v.fb_saves"></span>
                    </td>
                    <!-- Status -->
                    <td class="px-3 py-2.5 text-center">
                      <span class="badge"
                        :class="v.is_active ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'"
                        x-text="v.is_active ? 'Live' : 'Inactive'"></span>
                    </td>
                    <!-- Links -->
                    <td class="px-3 py-2.5" @click.stop>
                      <div class="flex items-center gap-1.5">
                        <a x-show="v.link" :href="v.link" target="_blank" rel="noopener"
                          class="text-xs text-fb hover:underline font-medium">VDP ↗</a>
                      </div>
                    </td>
                    <!-- Mock Pencil -->
                    <td class="px-3 py-2.5 text-center" @click.stop>
                      <div class="flex items-center justify-center gap-1.5">
                        <button
                          class="text-xs font-semibold px-2.5 py-1.5 rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-40 disabled:cursor-not-allowed"
                          @click.stop.prevent="openPencilDesk(v)">
                          :disabled="!v.price_ok"
                          @click="openPencilDesk(v)">
                          Desk
                        </button>
                        <button
                          class="text-xs font-semibold px-2.5 py-1.5 rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-40 disabled:cursor-not-allowed"
                          :disabled="!v.price_ok"
                          @click="downloadMockPencil(v)">
                          Download
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ══ ANALYTICS TAB ════════════════════════════════════════════════ -->
      <div x-show="tab==='analytics'" x-cloak class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

          <!-- Makes donut -->
          <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-5">
            <h3 class="text-sm font-bold text-slate-800 mb-4">Listings by Make</h3>
            <div class="relative h-52">
              <canvas id="makeChart"></canvas>
            </div>
            <div class="mt-4 space-y-1.5">
              <template x-for="[make, cnt] in Object.entries(summary.makes_breakdown || {})" :key="make">
                <div class="flex items-center justify-between text-xs">
                  <span class="text-slate-600 font-medium" x-text="make"></span>
                  <span class="font-bold text-slate-800" x-text="cnt"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- Body style donut -->
          <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-5">
            <h3 class="text-sm font-bold text-slate-800 mb-4">Listings by Body Style</h3>
            <div class="relative h-52">
              <canvas id="bodyChart"></canvas>
            </div>
            <div class="mt-4 space-y-1.5">
              <template x-for="[bs, cnt] in Object.entries(summary.body_breakdown || {})" :key="bs">
                <div class="flex items-center justify-between text-xs">
                  <span class="text-slate-600 font-medium" x-text="bs"></span>
                  <span class="font-bold text-slate-800" x-text="cnt"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- Year breakdown -->
          <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-5">
            <h3 class="text-sm font-bold text-slate-800 mb-4">Listings by Year</h3>
            <div class="relative h-52">
              <canvas id="yearChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Top clicked vehicles -->
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-5">
          <h3 class="text-sm font-bold text-slate-800 mb-4">Top Vehicles by FB Clicks</h3>
          <div class="space-y-3">
            <template x-if="topClicked.length === 0">
              <p class="text-sm text-slate-400">No click data yet — click "Refresh FB Stats" to fetch.</p>
            </template>
            <template x-for="(v, i) in topClicked" :key="v.vin">
              <div class="flex items-center gap-4">
                <span class="text-lg font-extrabold text-slate-200 w-6 text-right" x-text="i+1"></span>
                <div class="w-12 h-8 rounded overflow-hidden bg-slate-100 shrink-0">
                  <img x-show="v.image_url" :src="v.image_url" class="w-full h-full object-cover" loading="lazy" />
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-xs font-semibold text-slate-800 truncate" x-text="v.year + ' ' + v.make + ' ' + v.model + ' ' + v.trim"></p>
                  <p class="text-xs text-slate-400" x-text="v.vin"></p>
                </div>
                <div class="text-right shrink-0">
                  <p class="text-sm font-bold text-fb" x-text="v.fb_clicks + ' clicks'"></p>
                  <p class="text-xs text-slate-400" x-text="fmtBig(v.fb_impressions) + ' impr.'"></p>
                </div>
                <!-- click bar -->
                <div class="w-24 h-2 bg-slate-100 rounded-full overflow-hidden shrink-0">
                  <div class="h-full bg-fb rounded-full" :style="'width:' + Math.min(100, topClicked[0].fb_clicks ? (v.fb_clicks/topClicked[0].fb_clicks*100) : 0) + '%'"></div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Price range histogram -->
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-5">
          <h3 class="text-sm font-bold text-slate-800 mb-4">Price Distribution</h3>
          <div class="relative h-40">
            <canvas id="priceChart"></canvas>
          </div>
        </div>
      </div>

      <!-- ══ HISTORY TAB ══════════════════════════════════════════════════ -->
      <div x-show="tab==='history'" x-cloak>
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-50 border-b border-slate-100">
                <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">#</th>
                <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Date / Time</th>
                <th class="px-5 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Found</th>
                <th class="px-5 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Priced</th>
                <th class="px-5 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Uploaded</th>
                <th class="px-5 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Duration</th>
                <th class="px-5 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Result</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
              <template x-if="syncRuns.length === 0">
                <tr><td colspan="7" class="py-10 text-center text-slate-400 text-sm">No sync runs recorded yet.</td></tr>
              </template>
              <template x-for="r in syncRuns" :key="r.id">
                <tr class="hover:bg-slate-50 transition-colors">
                  <td class="px-5 py-3 text-slate-400 text-xs font-mono" x-text="r.id"></td>
                  <td class="px-5 py-3 text-xs" x-text="fmtDate(r.run_at)"></td>
                  <td class="px-5 py-3 text-right font-mono text-xs" x-text="r.vehicles_found"></td>
                  <td class="px-5 py-3 text-right font-mono text-xs" x-text="r.vehicles_priced"></td>
                  <td class="px-5 py-3 text-right font-mono text-xs" x-text="r.vehicles_uploaded"></td>
                  <td class="px-5 py-3 text-right text-xs text-slate-500" x-text="r.duration_seconds ? r.duration_seconds.toFixed(1) + 's' : '—'"></td>
                  <td class="px-5 py-3 text-center">
                    <span class="badge"
                      :class="r.success ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'"
                      x-text="r.success ? '✓ Success' : '✗ Failed'"></span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ══ DEAL HISTORY TAB ══════════════════════════════════════════════ -->
      <div x-show="tab==='deal_history'" x-cloak>
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-50 border-b border-slate-100">
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Vehicle</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Stock / VIN</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase">Sold Price</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase">Days Listed</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Benchmark</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
              <template x-if="dealHistory.length === 0">
                <tr><td colspan="5" class="py-10 text-center text-slate-400">No sold/deal history yet.</td></tr>
              </template>
              <template x-for="d in dealHistory" :key="d.vin + d.last_seen">
                <tr>
                  <td class="px-4 py-2.5 text-xs font-semibold text-slate-800" x-text="(d.year || '') + ' ' + (d.make || '') + ' ' + (d.model || '') + ' ' + (d.trim || '')"></td>
                  <td class="px-4 py-2.5 text-xs text-slate-500"><span x-text="d.stock_number || '—'"></span><br><span class="font-mono" x-text="d.vin"></span></td>
                  <td class="px-4 py-2.5 text-right text-xs font-semibold" x-text="d.sold_price ? fmtMoney(d.sold_price) : '—'"></td>
                  <td class="px-4 py-2.5 text-right text-xs" x-text="d.days_listed"></td>
                  <td class="px-4 py-2.5 text-xs text-slate-500" x-text="d.benchmark?.avg_days ? ('~' + d.benchmark.avg_days + ' days @ ' + fmtMoney(d.benchmark.avg_price || 0)) : '—'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ══ LOT WALK TAB ══════════════════════════════════════════════════ -->
      <div x-show="tab==='lot_walk'" x-cloak class="space-y-4 max-w-2xl">
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-5 space-y-3">
          <h3 class="text-sm font-bold text-slate-800">Lot Walk Mode</h3>
          <p class="text-xs text-slate-500">Scan or type stock # / VIN while on the lot.</p>
          <input x-model="lotWalkSearch" @input.debounce.150ms="lookupLotWalk()" placeholder="Stock # or VIN"
            class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb"/>
        </div>
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-5" x-show="lotWalkVehicle">
          <h4 class="font-bold text-slate-900 text-sm" x-text="lotWalkVehicle?.year + ' ' + lotWalkVehicle?.make + ' ' + lotWalkVehicle?.model"></h4>
          <p class="text-xs text-slate-500 mt-1" x-text="(lotWalkVehicle?.stock_number || '—') + ' · ' + lotWalkVehicle?.vin"></p>
          <div class="mt-3 grid grid-cols-2 gap-3 text-xs">
            <div class="rounded-lg bg-slate-50 p-2"><p class="text-slate-400">FB Clicks</p><p class="font-bold text-fb" x-text="lotWalkVehicle?.fb_clicks || 0"></p></div>
            <div class="rounded-lg bg-slate-50 p-2"><p class="text-slate-400">Impressions</p><p class="font-bold" x-text="fmtBig(lotWalkVehicle?.fb_impressions || 0)"></p></div>
            <div class="rounded-lg bg-slate-50 p-2"><p class="text-slate-400">Days on Lot</p><p class="font-bold" x-text="lotWalkVehicle?.days_on_lot || 0"></p></div>
            <div class="rounded-lg bg-slate-50 p-2"><p class="text-slate-400">% to Market</p><p class="font-bold" x-text="lotWalkVehicle?.pct_to_market != null ? ((lotWalkVehicle.pct_to_market > 0 ? '+' : '') + lotWalkVehicle.pct_to_market + '%') : '—'"></p></div>
          </div>
          <p x-show="lotWalkVehicle?.price_war_alert" class="mt-3 text-xs font-semibold text-red-600">⚠ Undercut overnight risk detected.</p>
        </div>
      </div>

      <!-- ══ USERS TAB (admin only) ════════════════════════════════════════ -->
      <div x-show="tab==='users' && isAdmin" x-cloak class="space-y-6">

        <!-- Create user form -->
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6">
          <h3 class="text-sm font-bold text-slate-800 mb-4">Create New User</h3>
          <div class="flex flex-wrap gap-3 items-end">
            <div>
              <label class="block text-xs text-slate-500 mb-1">Username</label>
              <input type="text" x-model="newUser.username" placeholder="e.g. John"
                class="px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb w-44"/>
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Password</label>
              <input type="text" x-model="newUser.password" placeholder="min 6 chars"
                class="px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb w-44"/>
            </div>
            <div class="flex items-center gap-2 pb-0.5">
              <input type="checkbox" id="newUserAdmin" x-model="newUser.is_admin" class="w-4 h-4 accent-fb"/>
              <label for="newUserAdmin" class="text-xs text-slate-600 font-medium">Admin</label>
            </div>
            <button class="btn-primary text-sm" @click="createUser()" :disabled="userSaving">
              <span x-show="!userSaving">Add User</span>
              <span x-show="userSaving">Adding…</span>
            </button>
            <p x-show="userMsg" class="text-xs font-semibold" :class="userMsgOk ? 'text-emerald-600' : 'text-red-500'" x-text="userMsg"></p>
          </div>
        </div>

        <!-- Users table -->
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-50 border-b border-slate-100">
                <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Username</th>
                <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Role</th>
                <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created</th>
                <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">New Password</th>
                <th class="px-5 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
              <template x-if="users.length === 0">
                <tr><td colspan="5" class="py-10 text-center text-slate-400 text-sm">No users yet.</td></tr>
              </template>
              <template x-for="u in users" :key="u.id">
                <tr class="hover:bg-slate-50 transition-colors">
                  <td class="px-5 py-3 font-semibold text-slate-800 text-sm flex items-center gap-2">
                    <div class="w-7 h-7 rounded-full bg-fb/10 flex items-center justify-center shrink-0">
                      <span class="text-fb text-xs font-bold" x-text="u.username.slice(0,1).toUpperCase()"></span>
                    </div>
                    <span x-text="u.username"></span>
                  </td>
                  <td class="px-5 py-3">
                    <span class="badge" :class="u.is_admin ? 'bg-fb/10 text-fb' : 'bg-slate-100 text-slate-500'"
                      x-text="u.is_admin ? 'Admin' : 'User'"></span>
                  </td>
                  <td class="px-5 py-3 text-xs text-slate-400" x-text="u.created_at ? u.created_at.replace('T',' ') : '—'"></td>
                  <td class="px-5 py-3">
                    <div class="flex gap-2 items-center">
                      <input type="text" :placeholder="'New password for ' + u.username"
                        x-model="pwdInputs[u.username]"
                        class="px-2 py-1 text-xs border border-slate-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-fb/30 focus:border-fb w-40"/>
                      <button class="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-600 font-medium transition-colors"
                        @click="changePassword(u.username)">Set</button>
                    </div>
                  </td>
                  <td class="px-5 py-3 text-center">
                    <button x-show="u.username.toLowerCase() !== currentUser.toLowerCase()"
                      class="text-xs px-3 py-1 rounded-lg bg-red-50 hover:bg-red-100 text-red-600 font-semibold transition-colors"
                      @click="deleteUser(u.username)">Delete</button>
                    <span x-show="u.username.toLowerCase() === currentUser.toLowerCase()" class="text-xs text-slate-300">You</span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ══ DEALS TAB ══════════════════════════════════════════════════════ -->
      <div x-show="tab==='deals'" class="space-y-5">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-base font-bold text-slate-800">Deal History</h2>
            <p class="text-xs text-slate-400">All saved pencil deals, newest first</p>
          </div>
        </div>

        <!-- Loading -->
        <div x-show="dealsLoading" class="text-center text-slate-400 py-12 text-sm animate-pulse">Loading deals…</div>

        <!-- Empty state -->
        <div x-show="!dealsLoading && deals.length === 0" class="text-center py-16 text-slate-400">
          <svg class="w-10 h-10 mx-auto mb-3 opacity-30 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/></svg>
          <p class="text-sm font-medium">No saved deals yet</p>
          <p class="text-xs mt-1">Click "Save Deal" inside the Pencil Desking tool to save a deal here.</p>
        </div>

        <!-- Table -->
        <div x-show="!dealsLoading && deals.length > 0" class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-50 border-b border-slate-100">
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Date</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vehicle</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Customer</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Internet Price</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">OTD Price</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Payment</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Front Gross</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">By</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
              <template x-for="d in deals" :key="d.id">
                <tr class="hover:bg-slate-50 transition-colors">
                  <td class="px-4 py-3 text-xs text-slate-400" x-text="d.created_at ? d.created_at.replace('T',' ').slice(0,16) : '—'"></td>
                  <td class="px-4 py-3">
                    <p class="font-semibold text-slate-800 text-xs" x-text="[d.year, d.make, d.model, d.trim].filter(Boolean).join(' ') || d.vin"></p>
                    <p class="text-xs text-slate-400" x-text="d.stock_number ? 'Stock #' + d.stock_number : d.vin"></p>
                  </td>
                  <td class="px-4 py-3 text-xs text-slate-600" x-text="d.customer_name || '—'"></td>
                  <td class="px-4 py-3 text-right font-semibold text-xs" x-text="d.base_price ? '$' + Number(d.base_price).toLocaleString() : '—'"></td>
                  <td class="px-4 py-3 text-right font-bold text-xs text-slate-800" x-text="d.out_the_door ? '$' + Number(d.out_the_door).toLocaleString() : '—'"></td>
                  <td class="px-4 py-3 text-right text-xs text-fb font-bold">
                    <span x-text="d.monthly_payment ? '$' + Number(d.monthly_payment).toFixed(0) + '/mo' : '—'"></span>
                    <p class="text-slate-400 font-normal" x-text="d.apr + '% · ' + d.term_months + ' mo'"></p>
                  </td>
                  <td class="px-4 py-3 text-right font-bold text-xs"
                    :class="(d.gross || 0) >= 0 ? 'text-emerald-600' : 'text-red-500'"
                    x-text="d.gross != null ? '$' + Number(d.gross).toLocaleString() : '—'"></td>
                  <td class="px-4 py-3 text-xs text-slate-500" x-text="d.created_by || '—'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ══ LOT WALK TAB ═════════════════════════════════════════════════ -->
      <div x-show="tab==='walk'" x-cloak>
        <div class="max-w-lg mx-auto py-6 space-y-4">
          <!-- Search box -->
          <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-5">
            <h2 class="text-base font-bold text-slate-900 mb-0.5">Lot Walk Mode</h2>
            <p class="text-xs text-slate-400 mb-3">Type a stock # or VIN to pull up a vehicle's live stats.</p>
            <div class="relative">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
              <input x-model="walkSearch" @input.debounce.400ms="searchWalk()"
                placeholder="Stock # or VIN…"
                class="w-full pl-9 pr-4 py-3 text-sm border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-400" />
              <div x-show="walkLoading" class="absolute right-3 top-1/2 -translate-y-1/2">
                <svg class="w-4 h-4 text-slate-400 fill-current spin-slow" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1z" clip-rule="evenodd"/></svg>
              </div>
            </div>
          </div>

          <!-- Vehicle card -->
          <template x-if="walkVehicle">
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
              <!-- Photo -->
              <div class="h-44 bg-slate-100 overflow-hidden">
                <img x-show="walkVehicle.image_url" :src="walkVehicle.image_url" :alt="walkVehicle.model"
                  class="w-full h-full object-cover" />
                <div x-show="!walkVehicle.image_url" class="w-full h-full flex items-center justify-center text-slate-300 text-sm">No photo</div>
              </div>
              <div class="p-5 space-y-4">
                <div>
                  <h3 class="text-xl font-extrabold text-slate-900 leading-tight"
                    x-text="walkVehicle.year + ' ' + walkVehicle.make + ' ' + walkVehicle.model + (walkVehicle.trim ? ' ' + walkVehicle.trim : '')"></h3>
                  <p class="text-sm text-slate-400 mt-0.5" x-text="[walkVehicle.exterior_color, walkVehicle.condition].filter(Boolean).join(' · ')"></p>
                </div>

                <!-- Key stats 2×2 grid -->
                <div class="grid grid-cols-2 gap-3">
                  <div class="bg-slate-50 rounded-xl p-3">
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Internet Price</p>
                    <p class="text-xl font-extrabold mt-1"
                      :class="walkVehicle.price_ok ? 'text-emerald-700' : 'text-slate-400'"
                      x-text="walkVehicle.price_ok ? '$' + fmt(walkVehicle.effective_price) : 'No Price'"></p>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3">
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Mileage</p>
                    <p class="text-xl font-extrabold text-slate-800 mt-1"
                      x-text="walkVehicle.mileage ? fmt(walkVehicle.mileage) + ' mi' : '—'"></p>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3">
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Days on Lot</p>
                    <p class="text-xl font-extrabold mt-1"
                      :class="walkDaysOnLot(walkVehicle) > 60 ? 'text-red-600' : walkDaysOnLot(walkVehicle) > 30 ? 'text-amber-600' : 'text-slate-800'"
                      x-text="walkDaysOnLot(walkVehicle) + ' days'"></p>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3">
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">% to Market</p>
                    <p class="text-xl font-extrabold mt-1"
                      :class="walkVehicle.pct_to_market > 5 ? 'text-red-600' : walkVehicle.pct_to_market < -2 ? 'text-emerald-600' : 'text-slate-800'"
                      x-text="walkVehicle.pct_to_market != null ? (walkVehicle.pct_to_market > 0 ? '+' : '') + walkVehicle.pct_to_market.toFixed(1) + '%' : '—'"></p>
                  </div>
                </div>

                <!-- FB stats row -->
                <div class="flex gap-3">
                  <div class="flex-1 text-center bg-blue-50 rounded-xl py-3">
                    <p class="text-xs font-semibold text-blue-400 uppercase tracking-wide">Clicks</p>
                    <p class="text-2xl font-extrabold text-blue-700 mt-0.5" x-text="walkVehicle.fb_clicks"></p>
                  </div>
                  <div class="flex-1 text-center bg-violet-50 rounded-xl py-3">
                    <p class="text-xs font-semibold text-violet-400 uppercase tracking-wide">Views</p>
                    <p class="text-2xl font-extrabold text-violet-700 mt-0.5" x-text="fmtBig(walkVehicle.fb_impressions)"></p>
                  </div>
                  <div class="flex-1 text-center bg-purple-50 rounded-xl py-3">
                    <p class="text-xs font-semibold text-purple-400 uppercase tracking-wide">Saves</p>
                    <p class="text-2xl font-extrabold text-purple-700 mt-0.5" x-text="walkVehicle.fb_saves"></p>
                  </div>
                </div>

                <!-- Price war alert -->
                <template x-if="priceWars[walkVehicle.vin]">
                  <div class="bg-red-50 border border-red-200 rounded-xl px-4 py-3 text-sm text-red-700 font-semibold flex items-center gap-2">
                    <svg class="w-4 h-4 fill-current shrink-0" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                    Price war detected — a competitor is undercutting this vehicle
                  </div>
                </template>

                <!-- Identifiers -->
                <div class="text-xs text-slate-400 font-mono space-y-0.5">
                  <div>Stock: <span class="text-slate-700 font-semibold" x-text="walkVehicle.stock_number || '—'"></span></div>
                  <div>VIN: <span x-text="walkVehicle.vin"></span></div>
                </div>

                <!-- Action buttons -->
                <div class="flex gap-2 pt-1">
                  <a x-show="walkVehicle.link" :href="walkVehicle.link" target="_blank"
                    class="flex-1 text-center font-semibold py-2.5 rounded-xl text-sm text-white transition-colors"
                    style="background:#1877F2">
                    View on Site ↗
                  </a>
                  <button @click="openModal(walkVehicle)"
                    class="flex-1 bg-slate-100 text-slate-700 font-semibold py-2.5 rounded-xl text-sm hover:bg-slate-200 transition-colors">
                    Full Details
                  </button>
                </div>
              </div>
            </div>
          </template>

          <!-- Not found -->
          <template x-if="walkSearch.length > 1 && !walkVehicle && !walkLoading">
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center text-slate-400 text-sm">
              No vehicle found matching "<span class="font-semibold" x-text="walkSearch"></span>"
            </div>
          </template>
        </div>
      </div>

    </div><!-- /main content -->
  </main>
</div>

<!-- ════════════════════════════════════════════════════════════════════════ -->
<!-- VEHICLE DETAIL MODAL                                                    -->
<!-- ════════════════════════════════════════════════════════════════════════ -->
<div x-show="modal" x-cloak
  class="fixed inset-0 z-50 flex items-center justify-center p-4"
  @keydown.escape.window="modal=null">
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="modal=null"></div>
  <!-- panel -->
  <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col" x-show="modal" x-transition>
    <!-- header -->
    <div class="flex items-start gap-4 p-6 border-b border-slate-100">
      <div class="w-24 h-16 rounded-xl overflow-hidden bg-slate-100 shrink-0">
        <img x-show="modal?.image_url" :src="modal?.image_url" class="w-full h-full object-cover" loading="lazy" />
      </div>
      <div class="flex-1 min-w-0">
        <h2 class="text-lg font-bold text-slate-900 leading-tight"
            x-text="modal?.year + ' ' + modal?.make + ' ' + modal?.model + ' ' + (modal?.trim || '')"></h2>
        <p class="text-xs text-slate-400 mt-1" x-text="modal?.vin"></p>
        <div class="flex items-center gap-2 mt-2 flex-wrap">
          <span class="badge"
            :class="modal?.is_active ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'"
            x-text="modal?.is_active ? 'Live on FB Marketplace' : 'Inactive'"></span>
          <span class="badge" :class="bodyBadge(modal?.body_style)" x-text="modal?.body_style || '?'"></span>
          <span class="badge bg-slate-100 text-slate-600" x-text="modal?.condition"></span>
          <!-- % to market badge -->
          <template x-if="modal?.pct_to_market !== null && modal?.pct_to_market !== undefined">
            <span class="badge font-mono"
              :class="modal.pct_to_market > 5 ? 'bg-red-100 text-red-700' : modal.pct_to_market < -5 ? 'bg-emerald-100 text-emerald-700' : 'bg-yellow-100 text-yellow-700'"
              x-text="(modal.pct_to_market > 0 ? '+' : '') + modal.pct_to_market.toFixed(1) + '% vs market'"></span>
          </template>
        </div>
      </div>
      <button @click="modal=null" class="text-slate-400 hover:text-slate-700 transition-colors shrink-0">
        <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
      </button>
    </div>

    <!-- Modal Tabs -->
    <div class="flex border-b border-slate-100 px-6">
      <button class="py-3 px-4 text-xs font-semibold border-b-2 transition-all mr-1"
        :class="modalTab==='details' ? 'border-fb text-fb' : 'border-transparent text-slate-400 hover:text-slate-700'"
        @click="modalTab='details'">Details</button>
      <button class="py-3 px-4 text-xs font-semibold border-b-2 transition-all mr-1"
        :class="modalTab==='edit' ? 'border-fb text-fb' : 'border-transparent text-slate-400 hover:text-slate-700'"
        @click="modalTab='edit'">Edit / Pricing</button>
      <button class="py-3 px-4 text-xs font-semibold border-b-2 transition-all flex items-center gap-1.5"
        :class="modalTab==='comps' ? 'border-fb text-fb' : 'border-transparent text-slate-400 hover:text-slate-700'"
        @click="modalTab='comps'; loadComparables()">
        Comparables
        <span x-show="comparables.length > 0" class="badge bg-slate-200 text-slate-600 text-xs" x-text="comparables.length"></span>
      </button>
      <button class="py-3 px-4 text-xs font-semibold border-b-2 transition-all flex items-center gap-1.5"
        :class="modalTab==='market' ? 'border-fb text-fb' : 'border-transparent text-slate-400 hover:text-slate-700'"
        @click="modalTab='market'; loadMarketComps()">
        Market
        <span x-show="marketComps.length > 0" class="badge bg-slate-200 text-slate-600 text-xs" x-text="marketComps.length"></span>
      </button>
      <button class="py-3 px-4 text-xs font-semibold border-b-2 transition-all mr-1"
        :class="modalTab==='specs' ? 'border-fb text-fb' : 'border-transparent text-slate-400 hover:text-slate-700'"
        @click="modalTab='specs'; loadVinSpecs()">VIN Specs</button>
      <button class="py-3 px-4 text-xs font-semibold border-b-2 transition-all"
        :class="modalTab==='sticker' ? 'border-fb text-fb' : 'border-transparent text-slate-400 hover:text-slate-700'"
        @click="modalTab='sticker'; loadWindowSticker()">Window Sticker</button>
    </div>

    <!-- ── DETAILS TAB ── -->
    <div x-show="modalTab==='details'" class="overflow-y-auto p-6 space-y-5 text-sm">
      <!-- Price block -->
      <div class="grid grid-cols-3 gap-3">
        <div class="bg-slate-50 rounded-xl p-3 text-center">
          <p class="text-xs text-slate-500 font-semibold">Effective Price</p>
          <template x-if="modal?.price_ok">
            <div>
              <p class="text-lg font-extrabold text-emerald-700 mt-1">$<span x-text="fmt(modal?.effective_price)"></span></p>
              <template x-if="modal?.price_overridden">
                <p class="text-xs text-amber-600 mt-0.5">Override (feed: $<span x-text="fmt(modal?.price_dollars)"></span>)</p>
              </template>
            </div>
          </template>
          <template x-if="!modal?.price_ok">
            <p class="text-lg font-extrabold text-red-500 mt-1">Not Found</p>
          </template>
        </div>
        <div class="bg-amber-50 rounded-xl p-3 text-center" x-show="modal?.effective_addendum > 0">
          <p class="text-xs text-amber-600 font-semibold">Addendum<span x-show="modal?.addendum_overridden"> (custom)</span></p>
          <p class="text-lg font-extrabold text-amber-700 mt-1">+$<span x-text="fmt(modal?.effective_addendum)"></span></p>
        </div>
        <div class="bg-slate-800 rounded-xl p-3 text-center" x-show="modal?.effective_addendum > 0 && modal?.price_ok">
          <p class="text-xs text-slate-400 font-semibold">Customer Price</p>
          <p class="text-lg font-extrabold text-white mt-1">$<span x-text="fmt(modal?.price_with_addendum)"></span></p>
        </div>
      </div>
      <!-- Market value row -->
      <template x-if="modal?.market_value">
        <div class="bg-slate-50 rounded-xl p-3 flex items-center justify-between">
          <div>
            <p class="text-xs font-semibold text-slate-500">Market Value (KBB / Reference)</p>
            <p class="text-base font-bold text-slate-800 mt-0.5">$<span x-text="fmt(modal?.market_value)"></span></p>
          </div>
          <template x-if="modal?.pct_to_market !== null && modal?.pct_to_market !== undefined">
            <span class="badge text-base px-3 py-1"
              :class="modal.pct_to_market > 5 ? 'bg-red-100 text-red-700' : modal.pct_to_market < -5 ? 'bg-emerald-100 text-emerald-700' : 'bg-yellow-100 text-yellow-700'"
              x-text="(modal.pct_to_market > 0 ? '+' : '') + modal.pct_to_market.toFixed(1) + '%'"></span>
          </template>
        </div>
      </template>
      <!-- Details grid -->
      <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-xs">
        <div><span class="text-slate-500">Stock #</span><span class="float-right font-semibold" x-text="modal?.stock_number || '—'"></span></div>
        <div><span class="text-slate-500">Mileage</span><span class="float-right font-semibold" x-text="modal?.mileage ? fmt(modal.mileage) + ' mi' : '—'"></span></div>
        <div><span class="text-slate-500">Color</span><span class="float-right font-semibold" x-text="modal?.exterior_color || '—'"></span></div>
        <div><span class="text-slate-500">Body Style</span><span class="float-right font-semibold" x-text="modal?.body_style || '—'"></span></div>
        <div><span class="text-slate-500">Condition</span><span class="float-right font-semibold capitalize" x-text="modal?.condition || '—'"></span></div>
        <div><span class="text-slate-500">First Seen</span><span class="float-right font-semibold" x-text="modal?.first_seen ? fmtDate(modal.first_seen) : '—'"></span></div>
        <div><span class="text-slate-500">Last Seen</span><span class="float-right font-semibold" x-text="modal?.last_seen ? fmtDate(modal.last_seen) : '—'"></span></div>
      </div>
      <!-- Notes display -->
      <template x-if="modal?.notes">
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-3">
          <p class="text-xs font-semibold text-yellow-700 mb-1">Internal Notes</p>
          <p class="text-xs text-slate-700" x-text="modal.notes"></p>
        </div>
      </template>
      <!-- FB Stats -->
      <div class="bg-fb/5 rounded-xl p-4">
        <p class="text-xs font-bold text-fb mb-3">Facebook Marketplace Performance</p>
        <div class="grid grid-cols-3 gap-3 text-center">
          <div>
            <p class="text-2xl font-extrabold text-fb" x-text="modal?.fb_clicks ?? 0"></p>
            <p class="text-xs text-slate-500 mt-0.5">Clicks</p>
          </div>
          <div>
            <p class="text-2xl font-extrabold text-violet-600" x-text="fmtBig(modal?.fb_impressions ?? 0)"></p>
            <p class="text-xs text-slate-500 mt-0.5">Impressions</p>
          </div>
          <div>
            <p class="text-2xl font-extrabold text-slate-700" x-text="modal?.fb_saves ?? 0"></p>
            <p class="text-xs text-slate-500 mt-0.5">Saves</p>
          </div>
        </div>
        <p class="text-xs text-slate-400 text-center mt-2" x-text="modal?.stats_date ? 'Stats as of ' + modal.stats_date : 'No stats yet — click Refresh FB Stats'"></p>
      </div>
      <div class="flex gap-3">
        <a x-show="modal?.link" :href="modal?.link" target="_blank" rel="noopener"
          class="btn-primary text-xs flex-1 justify-center">View VDP ↗</a>
      </div>
    </div>

    <!-- ── EDIT TAB ── -->
    <div x-show="modalTab==='edit'" class="overflow-y-auto p-6 space-y-5 text-sm">
      <p class="text-xs text-slate-400">Changes save immediately and persist across syncs. Clear a field to revert to the default.</p>

      <!-- Override Price -->
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Override Price <span class="text-slate-400 font-normal">(leave blank to use feed price: $<span x-text="fmt(modal?.price_dollars)"></span>)</span></label>
        <div class="flex gap-2">
          <div class="relative flex-1">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">$</span>
            <input type="number" min="0" step="1" x-model="editForm.price_override"
              placeholder="e.g. 27500"
              class="w-full pl-7 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb" />
          </div>
          <button class="btn-ghost text-xs" @click="editForm.price_override=''; saveVehicle({clear_price:true})">Clear</button>
        </div>
      </div>

      <!-- Market Value -->
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Market Value <span class="text-slate-400 font-normal">(KBB, MMR, or your reference price)</span></label>
        <div class="flex gap-2">
          <div class="relative flex-1">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">$</span>
            <input type="number" min="0" step="1" x-model="editForm.market_value"
              placeholder="e.g. 26000"
              class="w-full pl-7 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb" />
          </div>
          <button class="btn-ghost text-xs" @click="editForm.market_value=''; saveVehicle({clear_market_value:true})">Clear</button>
        </div>
        <template x-if="editForm.market_value && editForm.price_override">
          <p class="text-xs mt-1.5"
            :class="((editForm.price_override - editForm.market_value)/editForm.market_value*100) > 5 ? 'text-red-600' : ((editForm.price_override - editForm.market_value)/editForm.market_value*100) < -5 ? 'text-emerald-600' : 'text-yellow-600'"
            x-text="'Preview: ' + (((editForm.price_override - editForm.market_value)/editForm.market_value*100) > 0 ? '+' : '') + ((editForm.price_override - editForm.market_value)/editForm.market_value*100).toFixed(1) + '% vs market'"></p>
        </template>
      </div>

      <!-- Addendum Override -->
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Addendum Override <span class="text-slate-400 font-normal">(leave blank to use global: $<span x-text="fmt(settings.addendum_amount)"></span>)</span></label>
        <div class="flex gap-2">
          <div class="relative flex-1">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">$</span>
            <input type="number" min="0" step="1" x-model="editForm.addendum_override"
              placeholder="e.g. 1995"
              class="w-full pl-7 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb" />
          </div>
          <button class="btn-ghost text-xs" @click="editForm.addendum_override=''; saveVehicle({clear_addendum:true})">Clear</button>
        </div>
      </div>

      <!-- Notes -->
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Internal Notes</label>
        <textarea x-model="editForm.notes" rows="3" placeholder="e.g. Certified, flood check done, price negotiated with wholesaler…"
          class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb resize-none"></textarea>
      </div>

      <!-- Save / status -->
      <div class="flex items-center gap-3">
        <button class="btn-primary text-xs" @click="saveVehicle()" :disabled="savingVehicle">
          <span x-show="!savingVehicle">Save Changes</span>
          <span x-show="savingVehicle">Saving…</span>
        </button>
        <span x-show="saveMsg" class="text-xs text-emerald-600 font-semibold" x-text="saveMsg"></span>
      </div>
    </div>

    <!-- ── COMPARABLES TAB ── -->
    <div x-show="modalTab==='comps'" class="overflow-y-auto p-6 space-y-4 text-sm">
      <div x-show="loadingComps" class="text-center text-slate-400 text-xs py-6 animate-pulse">Loading comparables…</div>
      <div x-show="!loadingComps && comparables.length === 0" class="text-center text-slate-400 text-xs py-6">
        No other active listings with the same make &amp; model found.
      </div>
      <template x-if="!loadingComps && comparables.length > 0">
        <div>
          <p class="text-xs text-slate-400 mb-3">
            Other <strong x-text="modal?.make + ' ' + modal?.model"></strong> listings in your active catalog within ±4 years.
          </p>
          <div class="space-y-2">
            <template x-for="c in comparables" :key="c.vin">
              <div class="flex items-center gap-3 p-3 rounded-xl border"
                :class="c.is_near_duplicate ? 'border-amber-300 bg-amber-50' : 'border-slate-100 bg-slate-50'">
                <!-- thumb -->
                <div class="w-14 h-10 rounded-lg overflow-hidden bg-slate-200 shrink-0">
                  <img x-show="c.image_url" :src="c.image_url" class="w-full h-full object-cover" loading="lazy" />
                </div>
                <!-- info -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-1.5 flex-wrap">
                    <p class="text-xs font-semibold text-slate-800" x-text="c.year + ' ' + c.make + ' ' + c.model + (c.trim ? ' ' + c.trim : '')"></p>
                    <template x-if="c.is_near_duplicate">
                      <span class="badge bg-amber-200 text-amber-800">⚠ Near Duplicate</span>
                    </template>
                  </div>
                  <p class="text-xs text-slate-400" x-text="(c.mileage ? Number(c.mileage).toLocaleString() + ' mi · ' : '') + (c.exterior_color || '')"></p>
                </div>
                <!-- price -->
                <div class="text-right shrink-0">
                  <template x-if="c.effective_price">
                    <p class="text-sm font-bold text-emerald-700">$<span x-text="Number(c.effective_price).toLocaleString()"></span></p>
                  </template>
                  <template x-if="!c.effective_price">
                    <p class="text-xs text-slate-400">No price</p>
                  </template>
                  <!-- diff vs current -->
                  <template x-if="c.effective_price && modal?.effective_price">
                    <p class="text-xs"
                      :class="((c.effective_price - modal.effective_price)/modal.effective_price*100) > 0 ? 'text-slate-500' : 'text-emerald-600'"
                      x-text="(((c.effective_price - modal.effective_price)/modal.effective_price*100) > 0 ? '+' : '') + ((c.effective_price - modal.effective_price)/modal.effective_price*100).toFixed(1) + '% vs this'"></p>
                  </template>
                </div>
                <a :href="c.link" target="_blank" rel="noopener" x-show="c.link" class="text-xs text-fb hover:underline shrink-0">VDP ↗</a>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>

    <!-- ── MARKET TAB ── -->
    <div x-show="modalTab==='market'" class="overflow-y-auto p-6 space-y-4 text-sm">
      <!-- Loading -->
      <div x-show="loadingMarket" class="text-center text-slate-400 text-xs py-6 animate-pulse">Fetching competitor listings from MarketCheck…</div>

      <!-- Error -->
      <div x-show="marketError && !loadingMarket" class="bg-red-50 border border-red-200 rounded-xl p-4">
        <p class="text-xs font-semibold text-red-700" x-text="marketError"></p>
        <p x-show="marketError && marketError.includes('API key')" class="text-xs text-red-500 mt-1">Go to Settings → enter your MarketCheck API key and dealer ZIP.</p>
      </div>

      <!-- Summary bar -->
      <template x-if="!loadingMarket && !marketError && marketComps.length > 0">
        <div>
          <div class="flex gap-3 mb-4 flex-wrap">
            <div class="bg-slate-50 rounded-xl px-4 py-2 text-center">
              <p class="text-xs text-slate-400">Competitors</p>
              <p class="text-lg font-bold text-slate-800" x-text="marketComps.length"></p>
            </div>
            <div class="bg-red-50 rounded-xl px-4 py-2 text-center">
              <p class="text-xs text-red-500">Beating Our Price</p>
              <p class="text-lg font-bold text-red-600" x-text="marketComps.filter(c=>c.beats_us).length"></p>
            </div>
            <div class="bg-emerald-50 rounded-xl px-4 py-2 text-center">
              <p class="text-xs text-emerald-600">We Beat Them</p>
              <p class="text-lg font-bold text-emerald-700" x-text="marketComps.filter(c=>c.beats_us===false).length"></p>
            </div>
            <template x-if="marketSearch">
              <div class="bg-slate-50 rounded-xl px-4 py-2 text-center">
                <p class="text-xs text-slate-400">Search Radius</p>
                <p class="text-lg font-bold text-slate-800" x-text="marketSearch.radius + ' mi'"></p>
              </div>
            </template>
          </div>

          <!-- Our price reference -->
          <template x-if="marketOurPrice">
            <div class="flex items-center gap-2 mb-3 text-xs text-slate-500">
              <span class="inline-block w-3 h-3 rounded-full bg-fb shrink-0"></span>
              Our internet price: <strong class="text-slate-800" x-text="'$' + Number(marketOurPrice).toLocaleString()"></strong>
            </div>
          </template>

          <!-- Listings -->
          <div class="space-y-2">
            <template x-for="(c, i) in marketComps" :key="i">
              <div class="flex items-center gap-3 p-3 rounded-xl border transition-colors"
                :class="c.beats_us ? 'border-red-200 bg-red-50' : 'border-slate-100 bg-slate-50'">
                <!-- rank badge -->
                <div class="w-7 h-7 rounded-lg flex items-center justify-center shrink-0 text-xs font-bold"
                  :class="c.beats_us ? 'bg-red-200 text-red-800' : 'bg-slate-200 text-slate-600'"
                  x-text="i+1"></div>
                <!-- info -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-1.5 flex-wrap">
                    <p class="text-xs font-semibold text-slate-800" x-text="[c.year, c.heading || ''].join(' ').trim() || '—'"></p>
                    <template x-if="c.beats_us">
                      <span class="badge bg-red-200 text-red-800 text-xs">Cheaper</span>
                    </template>
                  </div>
                  <p class="text-xs text-slate-400" x-text="(c.miles ? Number(c.miles).toLocaleString() + ' mi · ' : '') + (c.exterior_color || '') + (c.trim ? ' · ' + c.trim : '')"></p>
                  <p class="text-xs text-slate-500 font-medium" x-text="[c.dealer_name, c.dealer_city, c.dealer_state].filter(Boolean).join(', ')"></p>
                  <p x-show="c.dom != null" class="text-xs text-slate-400" x-text="c.dom + ' days on market'"></p>
                </div>
                <!-- price -->
                <div class="text-right shrink-0">
                  <template x-if="c.price">
                    <p class="text-sm font-bold"
                      :class="c.beats_us ? 'text-red-600' : 'text-emerald-700'"
                      x-text="'$' + Number(c.price).toLocaleString()"></p>
                  </template>
                  <template x-if="!c.price"><p class="text-xs text-slate-400">No price</p></template>
                  <template x-if="c.price_diff != null">
                    <p class="text-xs font-semibold"
                      :class="c.beats_us ? 'text-red-500' : 'text-slate-400'"
                      x-text="(c.price_diff > 0 ? '+' : '') + '$' + Math.abs(c.price_diff).toLocaleString() + ' vs us'"></p>
                  </template>
                </div>
                <a x-show="c.vdp_url" :href="c.vdp_url" target="_blank" rel="noopener" class="text-xs text-fb hover:underline shrink-0">View ↗</a>
              </div>
            </template>
          </div>
        </div>
      </template>

      <!-- No results -->
      <div x-show="!loadingMarket && !marketError && marketComps.length === 0 && marketFetched"
        class="text-center text-slate-400 text-xs py-6">
        No competitor listings found within the search radius for this make/model.
      </div>

      <!-- Prompt to load -->
      <div x-show="!loadingMarket && !marketFetched && !marketError" class="text-center py-8">
        <button class="btn-primary text-xs" @click="loadMarketComps()">
          <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/></svg>
          Fetch Competitor Prices
        </button>
        <p class="text-xs text-slate-400 mt-2">Powered by MarketCheck — requires API key in Settings</p>
      </div>
    </div>

    <!-- ── VIN SPECS TAB ── -->
    <div x-show="modalTab==='specs'" class="overflow-y-auto p-6 space-y-4 text-sm">
      <div x-show="loadingSpecs" class="text-center text-slate-400 text-xs py-6 animate-pulse">Decoding VIN with MarketCheck…</div>
      <div x-show="specsError && !loadingSpecs" class="bg-red-50 border border-red-200 rounded-xl p-4">
        <p class="text-xs font-semibold text-red-700" x-text="specsError"></p>
      </div>
      <!-- Specs grid -->
      <template x-if="!loadingSpecs && !specsError && vinSpecs.length > 0">
        <div>
          <p class="text-xs text-slate-400 mb-3" x-show="vinSpecsCached">Cached from previous decode — no API call used.</p>
          <div class="grid grid-cols-2 gap-x-6 gap-y-1">
            <template x-for="(s, i) in vinSpecs" :key="i">
              <div class="flex items-start justify-between py-1.5 border-b border-slate-50 col-span-1">
                <span class="text-xs text-slate-500 font-medium" x-text="s.key || s.name"></span>
                <span class="text-xs text-slate-800 font-semibold text-right ml-2" x-text="s.value || s.value_description || '—'"></span>
              </div>
            </template>
          </div>
        </div>
      </template>
      <!-- Empty / prompt -->
      <div x-show="!loadingSpecs && !specsError && vinSpecs.length === 0 && vinSpecsFetched"
        class="text-center text-slate-400 text-xs py-6">No spec data returned for this VIN.</div>
      <div x-show="!loadingSpecs && !vinSpecsFetched && !specsError" class="text-center py-8">
        <button class="btn-primary text-xs" @click="loadVinSpecs()">
          <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/></svg>
          Decode VIN Specs
        </button>
        <p class="text-xs text-slate-400 mt-2">Engine, transmission, drivetrain &amp; more — powered by MarketCheck</p>
      </div>
    </div>

    <!-- ── WINDOW STICKER TAB ── -->
    <div x-show="modalTab==='sticker'" class="overflow-y-auto p-6 text-sm">
      <div x-show="loadingSticker" class="text-center text-slate-400 text-xs py-6 animate-pulse">Fetching window sticker…</div>
      <div x-show="stickerError && !loadingSticker" class="bg-red-50 border border-red-200 rounded-xl p-4">
        <p class="text-xs font-semibold text-red-700" x-text="stickerError"></p>
      </div>
      <!-- Sticker iframe -->
      <template x-if="!loadingSticker && !stickerError && stickerUrl">
        <div class="space-y-3">
          <p class="text-xs text-slate-400" x-show="stickerCached">Cached — no API call used.</p>
          <div class="flex gap-3">
            <a :href="stickerUrl" target="_blank"
              class="inline-flex items-center gap-2 px-4 py-2 bg-fb text-white text-xs font-semibold rounded-lg hover:bg-fb/90 transition-colors">
              <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 20 20"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>
              Open in New Tab
            </a>
          </div>
          <iframe :src="stickerUrl" class="w-full h-[60vh] border border-slate-200 rounded-xl" title="Window Sticker"></iframe>
        </div>
      </template>
      <!-- No sticker -->
      <div x-show="!loadingSticker && !stickerError && !stickerUrl && stickerFetched"
        class="text-center text-slate-400 text-xs py-6">No window sticker available for this VIN.</div>
      <!-- Prompt -->
      <div x-show="!loadingSticker && !stickerFetched && !stickerError" class="text-center py-8">
        <button class="btn-primary text-xs" @click="loadWindowSticker()">
          <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/></svg>
          Fetch Window Sticker
        </button>
        <p class="text-xs text-slate-400 mt-2">Original MSRP sticker — powered by MarketCheck</p>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════════════ -->
<!-- PENCIL DESKING MODAL                                                    -->
<!-- ════════════════════════════════════════════════════════════════════════ -->
<div x-show="pencilDeskOpen" x-cloak
  class="fixed inset-0 z-50 flex items-center justify-center p-4"
  @keydown.escape.window="pencilDeskOpen=false">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="pencilDeskOpen=false"></div>
  <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden max-h-[92vh] flex flex-col" x-transition>
    <div class="flex items-center justify-between p-6 border-b border-slate-100">
      <div>
        <h2 class="text-base font-bold text-slate-900">Pencil Desking Dashboard</h2>
        <p class="text-xs text-slate-400" x-text="pencilVehicle ? (pencilVehicle.year + ' ' + pencilVehicle.make + ' ' + pencilVehicle.model + ' · ' + (pencilVehicle.stock_number || pencilVehicle.vin)) : ''"></p>
      </div>
      <button @click="pencilDeskOpen=false" class="text-slate-400 hover:text-slate-700">
        <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
      </button>
    </div>
    <div class="p-6 overflow-y-auto grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="space-y-4">
        <div class="bg-slate-50 rounded-xl p-4 space-y-3">
          <h3 class="text-sm font-bold text-slate-800">Finance Inputs</h3>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-xs font-semibold text-slate-600">APR %
              <input type="number" step="0.1" min="0" x-model.number="mockPencil.apr" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
            <label class="text-xs font-semibold text-slate-600">Term (months)
              <input type="number" min="1" step="1" x-model.number="mockPencil.termMonths" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
          </div>
          <label class="text-xs font-semibold text-slate-600">Down Payment
            <input type="number" step="1" min="0" x-model.number="mockPencil.downPayment" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
          </label>
          <div class="border-t border-slate-200 pt-3">
            <p class="text-xs font-bold text-slate-700 mb-2">Gross Profit</p>
            <div class="grid grid-cols-2 gap-3">
              <label class="text-xs font-semibold text-slate-600">Vehicle Cost
                <input type="number" step="1" min="0" x-model.number="mockPencil.cost" placeholder="0"
                  class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
              </label>
              <label class="text-xs font-semibold text-slate-600">Pack
                <input type="number" step="1" min="0" x-model.number="mockPencil.pack" placeholder="0"
                  class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
              </label>
            </div>
          </div>
        </div>

        <div class="bg-slate-50 rounded-xl p-4 space-y-3">
          <h3 class="text-sm font-bold text-slate-800">Fee Setup (editable labels)</h3>
          <div class="grid grid-cols-5 gap-2 items-end">
            <label class="col-span-3 text-xs font-semibold text-slate-600">Addendum Label
              <input type="text" x-model="mockPencil.addendumLabel" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
            <label class="col-span-2 text-xs font-semibold text-slate-600">Amount
              <input type="number" min="0" step="1" x-model.number="mockPencil.addendumAmount" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
          </div>
          <div class="grid grid-cols-5 gap-2 items-end">
            <label class="col-span-3 text-xs font-semibold text-slate-600">Tax Label
              <input type="text" x-model="mockPencil.taxLabel" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
            <label class="col-span-2 text-xs font-semibold text-slate-600">Tax Rate %
              <input type="number" min="0" step="0.01" x-model.number="mockPencil.taxRate" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
          </div>
          <div class="grid grid-cols-5 gap-2 items-end">
            <label class="col-span-3 text-xs font-semibold text-slate-600">Doc Fee Label
              <input type="text" x-model="mockPencil.docFeeLabel" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
            <label class="col-span-2 text-xs font-semibold text-slate-600">Amount
              <input type="number" min="0" step="1" x-model.number="mockPencil.docFeeAmount" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
          </div>
        </div>
      </div>

      <div class="bg-white border border-slate-200 rounded-xl p-4 space-y-4">
        <h3 class="text-sm font-bold text-slate-800">Live Pencil Preview</h3>
        <table class="w-full text-sm">
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500">Internet Price</td><td class="py-2 text-right font-semibold" x-text="fmtMoney(pencilTotals().basePrice)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500" x-text="mockPencil.addendumLabel"></td><td class="py-2 text-right font-semibold" x-text="fmtMoney(pencilTotals().addendumAmount)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500" x-text="mockPencil.taxLabel + ' (' + Number(mockPencil.taxRate || 0).toFixed(2) + '%)'"></td><td class="py-2 text-right font-semibold" x-text="fmtMoney(pencilTotals().taxAmount)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500" x-text="mockPencil.docFeeLabel"></td><td class="py-2 text-right font-semibold" x-text="fmtMoney(pencilTotals().docFeeAmount)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500">Out-the-Door</td><td class="py-2 text-right font-bold text-slate-900" x-text="fmtMoney(pencilTotals().outTheDoor)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500">Down Payment</td><td class="py-2 text-right font-semibold" x-text="fmtMoney(mockPencil.downPayment)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500">Amount Financed</td><td class="py-2 text-right font-bold text-fb" x-text="fmtMoney(pencilTotals().amountFinanced)"></td></tr>
          <template x-if="mockPencil.cost > 0">
            <tr class="border-t-2 border-slate-200">
              <td class="py-2 font-semibold text-slate-700">Front End Gross</td>
              <td class="py-2 text-right font-bold text-lg"
                :class="pencilTotals().gross >= 0 ? 'text-emerald-600' : 'text-red-600'"
                x-text="fmtMoney(pencilTotals().gross)"></td>
            </tr>
          </template>
        </table>

        <div class="rounded-xl bg-fb/10 border border-fb/20 p-4">
          <p class="text-xs text-slate-600">Estimated Monthly Payment</p>
          <p class="text-3xl font-extrabold text-fb" x-text="fmtMoney(pencilTotals().monthlyPayment)"></p>
          <p class="text-xs text-slate-500 mt-1" x-text="Number(mockPencil.apr || 0).toFixed(2) + '% APR · ' + (mockPencil.termMonths || 0) + ' months'"></p>
        </div>

        <!-- Multi-term payment comparison -->
        <div class="bg-slate-50 rounded-xl p-4">
          <p class="text-xs font-bold text-slate-700 mb-3">Payment Comparison — <span x-text="Number(mockPencil.apr || 0).toFixed(2) + '% APR'"></span></p>
          <table class="w-full text-sm">
            <thead>
              <tr class="text-xs text-slate-500 border-b border-slate-200">
                <th class="pb-2 text-left font-semibold">Term</th>
                <th class="pb-2 text-right font-semibold">48 mo</th>
                <th class="pb-2 text-right font-semibold">60 mo</th>
                <th class="pb-2 text-right font-semibold text-fb">72 mo</th>
                <th class="pb-2 text-right font-semibold">84 mo</th>
              </tr>
            </thead>
            <tbody>
              <tr class="text-sm">
                <td class="py-1.5 text-slate-500 text-xs">Payment</td>
                <td class="py-1.5 text-right font-semibold" x-text="fmtMoney(calcPayment(pencilTotals().amountFinanced, mockPencil.apr, 48))"></td>
                <td class="py-1.5 text-right font-semibold" x-text="fmtMoney(calcPayment(pencilTotals().amountFinanced, mockPencil.apr, 60))"></td>
                <td class="py-1.5 text-right font-bold text-fb" x-text="fmtMoney(calcPayment(pencilTotals().amountFinanced, mockPencil.apr, 72))"></td>
                <td class="py-1.5 text-right font-semibold" x-text="fmtMoney(calcPayment(pencilTotals().amountFinanced, mockPencil.apr, 84))"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Customer name + action buttons -->
        <div class="border-t border-slate-100 pt-4 space-y-3">
          <div>
            <label class="text-xs font-semibold text-slate-600">Customer Name <span class="text-slate-400 font-normal">(optional)</span></label>
            <input type="text" x-model="pencilCustomerName" placeholder="e.g. John Smith"
              class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb" />
          </div>
          <div class="flex gap-2">
            <button class="btn-primary flex-1 justify-center" @click="downloadMockPencilPDF(pencilVehicle)" :disabled="!pencilVehicle || pdfGenerating">
              <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
              <span x-text="pdfGenerating ? 'Generating…' : 'Download PDF'"></span>
            </button>
            <button class="btn-ghost flex-1 justify-center border border-emerald-200 text-emerald-700 hover:bg-emerald-50"
              @click="saveDeal(pencilVehicle)" :disabled="!pencilVehicle || dealSaving">
              <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
              <span x-text="dealSaving ? 'Saving…' : 'Save Deal'"></span>
            </button>
          </div>
          <p x-show="dealSaveMsg" class="text-xs font-semibold text-center"
            :class="dealSaveOk ? 'text-emerald-600' : 'text-red-500'"
            x-text="dealSaveMsg"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════════════ -->
<!-- PENCIL DESKING MODAL                                                    -->
<!-- ════════════════════════════════════════════════════════════════════════ -->
<div x-show="pencilDeskOpen" x-cloak
  class="fixed inset-0 z-50 flex items-center justify-center p-4"
  @keydown.escape.window="pencilDeskOpen=false">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="pencilDeskOpen=false"></div>
  <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden max-h-[92vh] flex flex-col" x-transition>
    <div class="flex items-center justify-between p-6 border-b border-slate-100">
      <div>
        <h2 class="text-base font-bold text-slate-900">Pencil Desking Dashboard</h2>
        <p class="text-xs text-slate-400" x-text="pencilVehicle ? (pencilVehicle.year + ' ' + pencilVehicle.make + ' ' + pencilVehicle.model + ' · ' + (pencilVehicle.stock_number || pencilVehicle.vin)) : ''"></p>
      </div>
      <button @click="pencilDeskOpen=false" class="text-slate-400 hover:text-slate-700">
        <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
      </button>
    </div>
    <div class="p-6 overflow-y-auto grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="space-y-4">
        <div class="bg-slate-50 rounded-xl p-4 space-y-3">
          <h3 class="text-sm font-bold text-slate-800">Finance Inputs</h3>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-xs font-semibold text-slate-600">APR %
              <input type="number" step="0.1" min="0" x-model.number="mockPencil.apr" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
            <label class="text-xs font-semibold text-slate-600">Term (months)
              <input type="number" min="1" step="1" x-model.number="mockPencil.termMonths" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
          </div>
          <label class="text-xs font-semibold text-slate-600">Down Payment
            <input type="number" step="1" min="0" x-model.number="mockPencil.downPayment" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
          </label>
        </div>

        <div class="bg-slate-50 rounded-xl p-4 space-y-3">
          <h3 class="text-sm font-bold text-slate-800">Fee Setup (editable labels)</h3>
          <div class="grid grid-cols-5 gap-2 items-end">
            <label class="col-span-3 text-xs font-semibold text-slate-600">Addendum Label
              <input type="text" x-model="mockPencil.addendumLabel" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
            <label class="col-span-2 text-xs font-semibold text-slate-600">Amount
              <input type="number" min="0" step="1" x-model.number="mockPencil.addendumAmount" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
          </div>
          <div class="grid grid-cols-5 gap-2 items-end">
            <label class="col-span-3 text-xs font-semibold text-slate-600">Tax Label
              <input type="text" x-model="mockPencil.taxLabel" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
            <label class="col-span-2 text-xs font-semibold text-slate-600">Tax Rate %
              <input type="number" min="0" step="0.01" x-model.number="mockPencil.taxRate" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
          </div>
          <div class="grid grid-cols-5 gap-2 items-end">
            <label class="col-span-3 text-xs font-semibold text-slate-600">Doc Fee Label
              <input type="text" x-model="mockPencil.docFeeLabel" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
            <label class="col-span-2 text-xs font-semibold text-slate-600">Amount
              <input type="number" min="0" step="1" x-model.number="mockPencil.docFeeAmount" class="mt-1 w-full py-2 px-3 text-sm border border-slate-200 rounded-lg" />
            </label>
          </div>
        </div>
      </div>

      <div class="bg-white border border-slate-200 rounded-xl p-4 space-y-4">
        <h3 class="text-sm font-bold text-slate-800">Live Pencil Preview</h3>
        <table class="w-full text-sm">
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500">Internet Price</td><td class="py-2 text-right font-semibold" x-text="fmtMoney(pencilTotals().basePrice)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500" x-text="mockPencil.addendumLabel"></td><td class="py-2 text-right font-semibold" x-text="fmtMoney(pencilTotals().addendumAmount)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500" x-text="mockPencil.taxLabel + ' (' + Number(mockPencil.taxRate || 0).toFixed(2) + '%)'"></td><td class="py-2 text-right font-semibold" x-text="fmtMoney(pencilTotals().taxAmount)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500" x-text="mockPencil.docFeeLabel"></td><td class="py-2 text-right font-semibold" x-text="fmtMoney(pencilTotals().docFeeAmount)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500">Out-the-Door</td><td class="py-2 text-right font-bold text-slate-900" x-text="fmtMoney(pencilTotals().outTheDoor)"></td></tr>
          <tr class="border-b border-slate-100"><td class="py-2 text-slate-500">Down Payment</td><td class="py-2 text-right font-semibold" x-text="fmtMoney(mockPencil.downPayment)"></td></tr>
          <tr><td class="py-2 text-slate-500">Amount Financed</td><td class="py-2 text-right font-bold text-fb" x-text="fmtMoney(pencilTotals().amountFinanced)"></td></tr>
        </table>

        <div class="rounded-xl bg-fb/10 border border-fb/20 p-4">
          <p class="text-xs text-slate-600">Estimated Monthly Payment</p>
          <p class="text-3xl font-extrabold text-fb" x-text="fmtMoney(pencilTotals().monthlyPayment)"></p>
          <p class="text-xs text-slate-500 mt-1" x-text="Number(mockPencil.apr || 0).toFixed(2) + '% APR · ' + (mockPencil.termMonths || 0) + ' months'"></p>
        </div>

        <button class="btn-primary w-full justify-center" @click="downloadMockPencil(pencilVehicle)" :disabled="!pencilVehicle">Download Pencil</button>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════════════ -->
<!-- SETTINGS MODAL                                                          -->
<!-- ════════════════════════════════════════════════════════════════════════ -->
<div x-show="settingsOpen" x-cloak
  class="fixed inset-0 z-50 flex items-center justify-center p-4"
  @keydown.escape.window="settingsOpen=false">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="settingsOpen=false"></div>
  <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden" x-transition>
    <div class="flex items-center justify-between p-6 border-b border-slate-100">
      <h2 class="text-base font-bold text-slate-900">Dashboard Settings</h2>
      <button @click="settingsOpen=false" class="text-slate-400 hover:text-slate-700">
        <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
      </button>
    </div>
    <div class="p-6 space-y-5">
      <!-- Global addendum -->
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-1">Global Addendum Amount</label>
        <p class="text-xs text-slate-400 mb-2">Applied to all vehicles unless overridden per-vehicle. Set to 0 to disable.</p>
        <div class="flex gap-3 items-center">
          <div class="relative flex-1">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
            <input type="number" min="0" step="1" x-model="settings.addendum_amount"
              class="w-full pl-7 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb" />
          </div>
          <button class="btn-primary text-sm" @click="saveSettings()" :disabled="savingSettings">
            <span x-show="!savingSettings">Save</span>
            <span x-show="savingSettings">Saving…</span>
          </button>
        </div>
        <p x-show="settingsSaveMsg" class="text-xs text-emerald-600 font-semibold mt-2" x-text="settingsSaveMsg"></p>
      </div>
      <!-- Cox Report Import -->
      <div class="border-t border-slate-100 pt-5">
        <label class="block text-sm font-semibold text-slate-700 mb-1">Import Cox Auto Report</label>
        <p class="text-xs text-slate-400 mb-2">Paste your Cox inventory report. We'll extract Adj Cost To Market per VIN and derive Market Value automatically.</p>
        <textarea x-model="coxReportText" rows="5"
          placeholder="Paste Cox report here…"
          class="w-full py-2 px-3 text-xs border border-slate-200 rounded-lg resize-none font-mono focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb"></textarea>
        <div class="flex items-center gap-3 mt-2">
          <button class="btn-primary text-sm" @click="importCoxReport()"
            :disabled="coxImporting || !coxReportText.trim()">
            <span x-show="!coxImporting">Import</span>
            <span x-show="coxImporting">Importing…</span>
          </button>
          <p x-show="coxImportMsg" class="text-xs font-semibold"
            :class="coxImportOk ? 'text-emerald-600' : 'text-red-500'"
            x-text="coxImportMsg"></p>
        </div>
      </div>

      <!-- MarketCheck Integration -->
      <div class="border-t border-slate-100 pt-5">
        <label class="block text-sm font-semibold text-slate-700 mb-1">MarketCheck API Key</label>
        <p class="text-xs text-slate-400 mb-2">Powers the "Market" tab — live competitor prices near you.</p>
        <input type="text" x-model="settings.marketcheck_api_key" placeholder="e.g. xb7HUvJb…"
          class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb font-mono" />
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-1">MarketCheck API Secret</label>
        <input type="password" x-model="settings.marketcheck_api_secret" placeholder="e.g. zDgvfKPa…"
          class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb font-mono" />
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-1">Dealer ZIP Code</label>
        <p class="text-xs text-slate-400 mb-2">Center point for competitor search radius.</p>
        <div class="flex gap-2">
          <input type="text" x-model="settings.dealer_zip" placeholder="e.g. 78201"
            class="flex-1 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb" />
          <div class="flex items-center gap-1.5">
            <input type="number" min="10" max="500" step="10" x-model.number="settings.market_radius"
              class="w-20 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fb/30 focus:border-fb" />
            <span class="text-xs text-slate-400">mi radius</span>
          </div>
        </div>
        <button class="btn-primary text-sm mt-3" @click="saveSettings()" :disabled="savingSettings">
          <span x-show="!savingSettings">Save All Settings</span>
          <span x-show="savingSettings">Saving…</span>
        </button>
        <p x-show="settingsSaveMsg" class="text-xs text-emerald-600 font-semibold mt-2" x-text="settingsSaveMsg"></p>
      </div>

      <!-- Weekly Digest Email -->
      <div class="border-t border-slate-100 pt-5">
        <label class="block text-sm font-semibold text-slate-700 mb-1">Weekly Email Digest</label>
        <p class="text-xs text-slate-400 mb-3">Monday morning summary — top FB performers, aging units, price wars. Requires SMTP.</p>
        <div class="space-y-2">
          <div class="grid grid-cols-3 gap-2">
            <div class="col-span-2">
              <label class="block text-xs font-semibold text-slate-600 mb-1">SMTP Host</label>
              <input type="text" x-model="settings.smtp_host" placeholder="smtp.gmail.com"
                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-400" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Port</label>
              <input type="number" x-model.number="settings.smtp_port" placeholder="587"
                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-400" />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">SMTP Username</label>
              <input type="text" x-model="settings.smtp_user" placeholder="you@gmail.com"
                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-400" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">SMTP Password</label>
              <input type="password" x-model="settings.smtp_pass" placeholder="app password"
                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-400" />
            </div>
          </div>
          <div>
            <label class="block text-xs font-semibold text-slate-600 mb-1">Recipient Email(s)</label>
            <input type="text" x-model="settings.digest_email" placeholder="manager@dealer.com, gm@dealer.com"
              class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-400" />
          </div>
          <div class="flex items-center gap-3 pt-1">
            <button class="btn-primary text-sm" @click="saveSettings()" :disabled="savingSettings">
              <span x-show="!savingSettings">Save</span><span x-show="savingSettings">Saving…</span>
            </button>
            <button class="btn-ghost text-sm" @click="sendDigest()" :disabled="digestSending || !settings.digest_email">
              <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/></svg>
              <span x-text="digestSending ? 'Sending…' : 'Send Digest Now'"></span>
            </button>
            <p x-show="digestMsg" class="text-xs font-semibold"
              :class="digestOk ? 'text-emerald-600' : 'text-red-500'"
              x-text="digestMsg"></p>
          </div>
        </div>
      </div>

      <!-- Info -->
      <div class="bg-slate-50 rounded-xl p-4 text-xs text-slate-500 space-y-1">
        <p><strong class="text-slate-700">Per-vehicle overrides</strong> — open any vehicle, go to "Edit / Pricing" tab.</p>
        <p><strong class="text-slate-700">Market Value (% to Market)</strong> — enter a KBB or reference price per vehicle on the Edit tab, or import a Cox report above.</p>
        <p><strong class="text-slate-700">Comparables</strong> — same make &amp; model within ±4 years, from your active catalog.</p>
        <p><strong class="text-slate-700">Market tab</strong> — live competitor listings from MarketCheck (requires API key above).</p>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════════════ -->
<!-- ALPINE COMPONENT                                                        -->
<!-- ════════════════════════════════════════════════════════════════════════ -->
<script>
function dashboard() {
  return {
    tab: 'inventory',
    loading: true,
    vehicles: [],
    summary: {},
    syncRuns: [],
    dealHistory: [],
    makes: [],
    years: [],
    modal: null,
    modalTab: 'details',
    syncRunning: false,
    statsRunning: false,
    statusMsg: '',
    lastRefreshed: '—',
    filters: { search: '', make: '', year: '', condition: '', body_style: '', three_row: false },
    priceWars: {},
    // Lot Walk mode
    walkSearch: '',
    walkVehicle: null,
    walkLoading: false,
    // Email digest
    digestSending: false,
    digestMsg: '',
    digestOk: true,
    // auth
    currentUser: '',
    isAdmin: false,
    // settings modal
    settingsOpen: false,
    settings: { addendum_amount: 0, marketcheck_api_key: '', marketcheck_api_secret: '', dealer_zip: '', market_radius: 150, smtp_host: '', smtp_port: 587, smtp_user: '', smtp_pass: '', digest_email: '' },
    savingSettings: false,
    settingsSaveMsg: '',
    // vehicle edit
    editForm: { price_override: '', addendum_override: '', market_value: '', notes: '' },
    savingVehicle: false,
    saveMsg: '',
    // comparables
    comparables: [],
    loadingComps: false,
    // user management
    users: [],
    newUser: { username: '', password: '', is_admin: false },
    userSaving: false,
    userMsg: '',
    userMsgOk: true,
    pwdInputs: {},
    pencilDeskOpen: false,
    pencilVehicle: null,
    mockPencil: {
      apr: 6.9,
      termMonths: 72,
      downPayment: 0,
      addendumLabel: 'Addendum',
      addendumAmount: 4400,
      taxLabel: 'Sales Tax',
      taxRate: 6.25,
      docFeeLabel: 'Doc Fee',
      docFeeAmount: 225,
      cost: 0,
      pack: 0,
    },
    // Cox report import
    coxReportText: '',
    coxImporting: false,
    coxImportMsg: '',
    coxImportOk: true,
    // deals history
    deals: [],
    dealsLoading: false,
    // pencil save deal
    pencilCustomerName: '',
    dealSaving: false,
    dealSaveMsg: '',
    dealSaveOk: true,
    // PDF generation
    pdfGenerating: false,
    // market comps
    marketComps: [],
    marketOurPrice: null,
    marketSearch: null,
    marketError: '',
    marketFetched: false,
    loadingMarket: false,
    // vin specs
    vinSpecs: [],
    vinSpecsFetched: false,
    vinSpecsCached: false,
    loadingSpecs: false,
    specsError: '',
    // window sticker
    stickerUrl: '',
    stickerFetched: false,
    stickerCached: false,
    loadingSticker: false,
    stickerError: '',

    get bodyStyles() {
      const set = new Set(this.vehicles.map(v => v.body_style).filter(Boolean))
      return [...set].sort()
    },
    get topClicked() {
      return [...this.vehicles].sort((a,b) => b.fb_clicks - a.fb_clicks).slice(0, 8)
    },

    async init() {
      await this.loadMe()
      await Promise.all([this.loadSummary(), this.loadVehicles(), this.loadMeta(), this.loadRuns(), this.loadSettings(), this.loadDealHistory()])
      this.lastRefreshed = new Date().toLocaleTimeString()
      this.$nextTick(() => this.drawCharts())
    },

    async reload() {
      this.loading = true
      await this.init()
    },

    async loadMe() {
      const r = await fetch('/api/me')
      if (r.status === 401) { window.location.href = '/login'; return }
      const d = await r.json()
      this.currentUser = d.username
      this.isAdmin = d.is_admin
    },

    async logout() {
      await fetch('/api/logout', { method: 'POST' })
      window.location.href = '/login'
    },

    async loadUsers() {
      if (!this.isAdmin) return
      const r = await fetch('/api/users')
      if (r.ok) { const d = await r.json(); this.users = d.users }
    },

    async createUser() {
      this.userMsg = ''
      if (!this.newUser.username.trim() || !this.newUser.password.trim()) {
        this.userMsg = 'Username and password are required'; this.userMsgOk = false; return
      }
      this.userSaving = true
      const r = await fetch('/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(this.newUser),
      })
      const d = await r.json()
      this.userSaving = false
      if (r.ok) {
        this.users = d.users
        this.newUser = { username: '', password: '', is_admin: false }
        this.userMsg = 'User created'; this.userMsgOk = true
      } else {
        this.userMsg = d.detail || 'Error'; this.userMsgOk = false
      }
      setTimeout(() => this.userMsg = '', 4000)
    },

    async deleteUser(username) {
      if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return
      const r = await fetch(`/api/users/${encodeURIComponent(username)}`, { method: 'DELETE' })
      const d = await r.json()
      if (r.ok) { this.users = d.users }
      else { alert(d.detail || 'Error deleting user') }
    },

    async changePassword(username) {
      const pw = this.pwdInputs[username]
      if (!pw || pw.length < 6) { alert('Password must be at least 6 characters'); return }
      const r = await fetch(`/api/users/${encodeURIComponent(username)}/password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ new_password: pw }),
      })
      if (r.ok) {
        this.pwdInputs[username] = ''
        alert(`Password updated for ${username}`)
      } else {
        const d = await r.json()
        alert(d.detail || 'Error updating password')
      }
    },

    async loadSummary() {
      const r = await fetch('/api/summary')
      if (r.status === 401) { window.location.href = '/login'; return }
      this.summary = await r.json()
    },

    async loadSettings() {
      const r = await fetch('/api/settings')
      this.settings = await r.json()
    },

    async saveSettings() {
      this.savingSettings = true
      this.settingsSaveMsg = ''
      const r = await fetch('/api/settings', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          addendum_amount:          parseInt(this.settings.addendum_amount) || 0,
          marketcheck_api_key:      this.settings.marketcheck_api_key || '',
          marketcheck_api_secret:   this.settings.marketcheck_api_secret || '',
          dealer_zip:               this.settings.dealer_zip || '',
          market_radius:            parseInt(this.settings.market_radius) || 150,
          smtp_host:                this.settings.smtp_host || '',
          smtp_port:                parseInt(this.settings.smtp_port) || 587,
          smtp_user:                this.settings.smtp_user || '',
          smtp_pass:                this.settings.smtp_pass || '',
          digest_email:             this.settings.digest_email || '',
        })
      })
      const d = await r.json()
      this.settings = d
      this.summary.addendum_amount = d.addendum_amount
      this.savingSettings = false
      this.settingsSaveMsg = 'Saved!'
      setTimeout(() => this.settingsSaveMsg = '', 3000)
      // reload vehicles to recompute prices
      this.loadVehicles()
    },

    async loadVehicles() {
      this.loading = true
      const p = new URLSearchParams(
        Object.fromEntries(
          Object.entries(this.filters).filter(([k, v]) => v !== '' && v !== false && v !== null)
        )
      )
      const r = await fetch('/api/vehicles?' + p)
      const d = await r.json()
      this.vehicles = d.vehicles
      this.loading = false
    },

    async loadMeta() {
      const [mr, yr] = await Promise.all([fetch('/api/makes'), fetch('/api/years')])
      const md = await mr.json(); const yd = await yr.json()
      this.makes = md.makes; this.years = yd.years
    },

    async loadRuns() {
      const r = await fetch('/api/sync-runs?limit=30')
      const d = await r.json()
      this.syncRuns = d.runs
    },

    async loadDealHistory() {
      const r = await fetch('/api/deal-history?limit=100')
      if (!r.ok) return
      const d = await r.json()
      this.dealHistory = d.deals || []
    },

    lookupLotWalk() {
      const q = (this.lotWalkSearch || '').trim().toLowerCase()
      if (!q) { this.lotWalkVehicle = null; return }
      this.lotWalkVehicle = this.vehicles.find(v =>
        (v.stock_number || '').toLowerCase().includes(q) ||
        (v.vin || '').toLowerCase().includes(q)
      ) || null
    },

    async sendWeeklyDigest() {
      const r = await fetch('/api/weekly-digest', { method: 'POST' })
      const d = await r.json()
      if (r.ok) {
        this.statusMsg = 'Weekly digest generated (' + (d.digest?.generated_at || 'now') + ')'
      } else {
        this.statusMsg = d.detail || 'Failed to generate digest'
      }
      setTimeout(() => this.statusMsg = '', 6000)
    },

    clearFilters() {
      this.filters = { search:'', make:'', year:'', condition:'', body_style:'', three_row: false }
      this.loadVehicles()
    },

    openModal(v, tab='details') {
      this.modal = v
      this.modalTab = tab
      this.comparables = []
      this.marketComps = []
      this.marketError = ''
      this.marketFetched = false
      this.vinSpecs = []
      this.vinSpecsFetched = false
      this.vinSpecsCached = false
      this.specsError = ''
      this.stickerUrl = ''
      this.stickerFetched = false
      this.stickerCached = false
      this.stickerError = ''
      this.saveMsg = ''
      this.editForm = {
        price_override:    v.price_override   != null ? String(v.price_override)   : '',
        addendum_override: v.addendum_override != null ? String(v.addendum_override): '',
        market_value:      v.market_value      != null ? String(v.market_value)     : '',
        notes:             v.notes || '',
      }
      if (tab === 'comps') this.loadComparables()
    },

    async loadComparables() {
      if (!this.modal) return
      this.loadingComps = true
      const r = await fetch('/api/comparable/' + this.modal.vin)
      const d = await r.json()
      this.comparables = d.comparables || []
      this.loadingComps = false
    },

    async saveVehicle(extra = {}) {
      if (!this.modal) return
      this.savingVehicle = true
      this.saveMsg = ''
      const payload = {
        ...extra,
        notes: this.editForm.notes,
      }
      if (!extra.clear_price && this.editForm.price_override !== '')
        payload.price_override = parseInt(this.editForm.price_override) || null
      if (!extra.clear_addendum && this.editForm.addendum_override !== '')
        payload.addendum_override = parseInt(this.editForm.addendum_override) || null
      if (!extra.clear_market_value && this.editForm.market_value !== '')
        payload.market_value = parseInt(this.editForm.market_value) || null

      const r = await fetch('/api/vehicle/' + this.modal.vin + '/update', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      })
      if (r.ok) {
        const updated = await r.json()
        this.modal = updated
        // update in vehicle list too
        const idx = this.vehicles.findIndex(v => v.vin === updated.vin)
        if (idx >= 0) this.vehicles[idx] = updated
        this.editForm = {
          price_override:    updated.price_override    != null ? String(updated.price_override)    : '',
          addendum_override: updated.addendum_override != null ? String(updated.addendum_override) : '',
          market_value:      updated.market_value      != null ? String(updated.market_value)      : '',
          notes:             updated.notes || '',
        }
        this.saveMsg = 'Saved!'
        setTimeout(() => this.saveMsg = '', 3000)
      } else {
        this.saveMsg = 'Error saving — try again'
      }
      this.savingVehicle = false
    },

    async triggerSync() {
      if (this.syncRunning) return
      this.syncRunning = true
      this.statusMsg = 'Sync started…'
      await fetch('/api/trigger-sync', { method: 'POST' })
      // Poll status every 3s
      const poll = setInterval(async () => {
        const r = await fetch('/api/sync-status')
        const d = await r.json()
        this.statusMsg = d.last_message
        if (!d.running) {
          clearInterval(poll)
          this.syncRunning = false
          await this.init()
          setTimeout(() => this.statusMsg = '', 5000)
        }
      }, 3000)
    },

    async refreshStats() {
      if (this.statsRunning) return
      this.statsRunning = true
      this.statusMsg = 'Fetching FB stats…'
      await fetch('/api/refresh-fb-stats', { method: 'POST' })
      const poll = setInterval(async () => {
        const r = await fetch('/api/fb-stats-status')
        const d = await r.json()
        this.statusMsg = d.last_message
        if (!d.running) {
          clearInterval(poll)
          this.statsRunning = false
          await this.init()
          setTimeout(() => this.statusMsg = '', 8000)
        }
      }, 2000)
    },

    tabLabel() {
      return { inventory:'Inventory', analytics:'Analytics', history:'Sync History', users:'User Management', deals:'Deal History', walk:'Lot Walk' }[this.tab] || ''
    },

    ctr() {
      const i = this.summary.total_impressions
      const c = this.summary.total_clicks
      if (!i || !c) return '—'
      return (c/i*100).toFixed(2) + '%'
    },

    fmt(n) {
      if (n == null || n === '') return '—'
      return Number(n).toLocaleString('en-US')
    },

    fmtMoney(n) {
      return Number(n || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })
    },

    async importCoxReport() {
      this.coxImporting = true
      this.coxImportMsg = ''
      try {
        const r = await fetch('/api/cox-import', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({raw_text: this.coxReportText}),
        })
        const d = await r.json()
        if (r.ok) {
          this.coxImportMsg = `Updated ${d.updated} vehicles (${d.skipped} not in inventory)`
          this.coxImportOk  = true
          this.coxReportText = ''
          await this.loadVehicles()
        } else {
          this.coxImportMsg = d.detail || 'Import failed'
          this.coxImportOk  = false
        }
      } catch(e) {
        this.coxImportMsg = 'Network error'
        this.coxImportOk  = false
      }
      this.coxImporting = false
    },

    async searchWalk() {
      if (this.walkSearch.trim().length < 2) { this.walkVehicle = null; return }
      this.walkLoading = true
      try {
        const p = new URLSearchParams({ search: this.walkSearch.trim() })
        const r = await fetch('/api/vehicles?' + p)
        if (r.ok) {
          const d = await r.json()
          this.walkVehicle = d.vehicles?.[0] || null
        }
      } catch(e) { this.walkVehicle = null }
      this.walkLoading = false
    },

    walkDaysOnLot(v) {
      if (!v?.first_seen) return 0
      try {
        const fs = new Date(v.first_seen.endsWith('Z') ? v.first_seen : v.first_seen + 'Z')
        return Math.max(0, Math.floor((Date.now() - fs.getTime()) / 86400000))
      } catch { return 0 }
    },

    async sendDigest() {
      this.digestSending = true
      this.digestMsg = ''
      try {
        const r = await fetch('/api/send-digest', { method: 'POST' })
        const d = await r.json()
        if (r.ok) {
          this.digestMsg = d.message || 'Digest sent!'
          this.digestOk = true
        } else {
          this.digestMsg = d.detail || 'Failed to send digest'
          this.digestOk = false
        }
      } catch(e) {
        this.digestMsg = 'Network error'
        this.digestOk = false
      }
      this.digestSending = false
      setTimeout(() => this.digestMsg = '', 6000)
    },

    openPencilDesk(v) {
      this.pencilVehicle = v
      this.mockPencil.cost = Number(v.cost || 0)
      this.pencilDeskOpen = true
    },

    pencilTotals() {
      const basePrice      = Number(this.pencilVehicle?.effective_price || 0)
      const addendumAmount = Number(this.mockPencil.addendumAmount || 0)
      const taxAmount      = Number(((basePrice + addendumAmount) * (Number(this.mockPencil.taxRate || 0) / 100)).toFixed(2))
      const docFeeAmount   = Number(this.mockPencil.docFeeAmount || 0)
      const downPayment    = Number(this.mockPencil.downPayment || 0)
      const outTheDoor     = basePrice + addendumAmount + taxAmount + docFeeAmount
      const amountFinanced = Math.max(0, outTheDoor - downPayment)
      const monthlyRate    = Number(this.mockPencil.apr || 0) / 100 / 12
      const n              = Number(this.mockPencil.termMonths || 1)
      const monthlyPayment = monthlyRate > 0
        ? amountFinanced * monthlyRate / (1 - Math.pow(1 + monthlyRate, -n))
        : amountFinanced / n
      const cost  = Number(this.mockPencil.cost || 0)
      const pack  = Number(this.mockPencil.pack || 0)
      const gross = (basePrice + addendumAmount) - cost - pack
      return { basePrice, addendumAmount, taxAmount, docFeeAmount, outTheDoor, amountFinanced, monthlyPayment, gross, cost, pack }
    },

    calcPayment(amount, apr, months) {
      const r = Number(apr || 0) / 100 / 12
      const n = Number(months || 1)
      if (r <= 0) return amount / n
      return amount * r / (1 - Math.pow(1 + r, -n))
    },

    async loadDeals() {
      this.dealsLoading = true
      const r = await fetch('/api/deals?limit=100')
      if (r.ok) { const d = await r.json(); this.deals = d.deals }
      this.dealsLoading = false
    },

    async saveDeal(v) {
      if (!v?.price_ok || !v?.effective_price) {
        alert('This unit needs an internet price before saving a deal.')
        return
      }
      this.dealSaving = true
      this.dealSaveMsg = ''
      const t = this.pencilTotals()
      const payload = {
        vin:             v.vin,
        customer_name:   this.pencilCustomerName,
        base_price:      Math.round(t.basePrice),
        addendum_amount: Math.round(t.addendumAmount),
        tax_rate:        Number(this.mockPencil.taxRate || 0),
        doc_fee:         Math.round(t.docFeeAmount),
        down_payment:    Math.round(Number(this.mockPencil.downPayment || 0)),
        apr:             Number(this.mockPencil.apr || 0),
        term_months:     Number(this.mockPencil.termMonths || 72),
        out_the_door:    Math.round(t.outTheDoor),
        amount_financed: Math.round(t.amountFinanced),
        monthly_payment: Number(t.monthlyPayment.toFixed(2)),
        gross:           Math.round(t.gross),
      }
      try {
        const r = await fetch('/api/deals', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload),
        })
        if (r.ok) {
          this.dealSaveMsg = 'Deal saved!'
          this.dealSaveOk = true
        } else {
          const d = await r.json()
          this.dealSaveMsg = d.detail || 'Error saving deal'
          this.dealSaveOk = false
        }
      } catch(e) {
        this.dealSaveMsg = 'Network error'
        this.dealSaveOk = false
      }
      this.dealSaving = false
      setTimeout(() => this.dealSaveMsg = '', 4000)
    },

    async loadMarketComps() {
      if (!this.modal?.vin) return
      this.loadingMarket = true
      this.marketError = ''
      this.marketComps = []
      this.marketFetched = false
      try {
        const r = await fetch('/api/market-comps/' + encodeURIComponent(this.modal.vin))
        const d = await r.json()
        if (r.ok) {
          this.marketComps  = d.listings
          this.marketOurPrice = d.our_price
          this.marketSearch  = d.search
          this.marketFetched = true
          // Update price war map for this VIN
          if (this.modal?.vin) {
            this.priceWars[this.modal.vin] = d.listings.some(c => c.beats_us)
          }
        } else {
          this.marketError  = d.detail || 'Failed to fetch competitor data'
        }
      } catch(e) {
        this.marketError = 'Network error — could not reach MarketCheck'
      }
      this.loadingMarket = false
    },

    async loadVinSpecs() {
      if (!this.modal?.vin) return
      this.loadingSpecs = true
      this.specsError = ''
      try {
        const r = await fetch('/api/vin-decode/' + encodeURIComponent(this.modal.vin))
        const d = await r.json()
        if (r.ok) {
          this.vinSpecs = d.specs || []
          this.vinSpecsCached = d.cached
          this.vinSpecsFetched = true
        } else {
          this.specsError = d.detail || 'VIN decode failed'
        }
      } catch(e) {
        this.specsError = 'Network error — could not reach MarketCheck'
      }
      this.loadingSpecs = false
    },

    async loadWindowSticker() {
      if (!this.modal?.vin) return
      this.loadingSticker = true
      this.stickerError = ''
      try {
        const r = await fetch('/api/window-sticker/' + encodeURIComponent(this.modal.vin))
        const d = await r.json()
        if (r.ok) {
          this.stickerUrl = d.sticker_url || ''
          this.stickerCached = d.cached
          this.stickerFetched = true
        } else {
          this.stickerError = d.detail || 'Window sticker fetch failed'
        }
      } catch(e) {
        this.stickerError = 'Network error — could not reach MarketCheck'
      }
      this.loadingSticker = false
    },

    async downloadMockPencilPDF(v) {
      if (!v?.price_ok || !v?.effective_price) {
        alert('This unit needs an internet price before generating a PDF.')
        return
      }
      this.pdfGenerating = true
      // Build the worksheet HTML (same content, no outer html/head/body wrapper)
      const basePrice      = Number(v.effective_price)
      const addendum       = Number(this.mockPencil.addendumAmount || 0)
      const taxRate        = Number(this.mockPencil.taxRate || 0) / 100
      const taxAmount      = Number(((basePrice + addendum) * taxRate).toFixed(2))
      const docFee         = Number(this.mockPencil.docFeeAmount || 0)
      const downPayment    = Number(this.mockPencil.downPayment || 0)
      const outTheDoor     = Number((basePrice + addendum + taxAmount + docFee).toFixed(2))
      const amountFinanced = Math.max(0, outTheDoor - downPayment)
      const apr            = Number(this.mockPencil.apr || 0)
      const cost           = Number(this.mockPencil.cost || 0)
      const pack           = Number(this.mockPencil.pack || 0)
      const gross          = (basePrice + addendum) - cost - pack
      const calcPmt = (amt, a, n) => { const r = a/100/12; if(r<=0) return amt/n; return amt*r/(1-Math.pow(1+r,-n)) }
      const fmt    = n => Number(n||0).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0})
      const fmtD   = n => Number(n||0).toLocaleString('en-US',{style:'currency',currency:'USD'})
      const vehicleLabel = `${v.year||''} ${v.make||''} ${v.model||''}`.trim()
      const fullLabel    = v.trim ? `${vehicleLabel} ${v.trim}` : vehicleLabel
      const stock   = v.stock_number || 'N/A'
      const vin     = v.vin || 'N/A'
      const mileage = v.mileage ? Number(v.mileage).toLocaleString() + ' mi' : '—'
      const color   = v.exterior_color || '—'
      const dateStr = new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})
      const imgUrl  = v.image_url || ''
      const addendumLabel = this.mockPencil.addendumLabel || 'Addendum'
      const taxLabel      = this.mockPencil.taxLabel || 'Sales Tax'
      const docFeeLabel   = this.mockPencil.docFeeLabel || 'Doc Fee'
      const terms   = [48, 60, 72, 84]
      const pmtCols = terms.map(t => {
        const pmt = calcPmt(amountFinanced, apr, t)
        const hi  = t === 72
        return `<td style="padding:16px 12px;text-align:center;background:${hi?'#1877F2':'#f8fafc'};border-radius:10px;vertical-align:top;">
          <div style="font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:${hi?'rgba(255,255,255,.75)':'#94a3b8'};margin-bottom:6px;">${t} mo</div>
          <div style="font-size:22px;font-weight:800;color:${hi?'#fff':'#0f172a'};line-height:1;">${fmtD(pmt)}</div>
          <div style="font-size:10px;color:${hi?'rgba(255,255,255,.65)':'#94a3b8'};margin-top:4px;">per month</div>
        </td>`
      }).join('<td style="width:8px;"></td>')

      const worksheetHTML = `
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Arial,system-ui,sans-serif;background:#f1f5f9;color:#0f172a;}
.page{max-width:780px;margin:0 auto;background:#fff;border-radius:16px;overflow:hidden;}
.hd{background:#0f172a;padding:28px 32px;display:flex;align-items:center;justify-content:space-between;}
.hd-left h1{font-size:20px;font-weight:800;color:#fff;}
.hd-left p{font-size:12px;color:#94a3b8;margin-top:4px;font-weight:500;letter-spacing:.04em;text-transform:uppercase;}
.hd-right{text-align:right;}
.hd-right .badge{display:inline-block;background:#1877F2;color:#fff;font-size:11px;font-weight:700;padding:5px 12px;border-radius:20px;letter-spacing:.04em;text-transform:uppercase;}
.hd-right .date{font-size:11px;color:#64748b;margin-top:6px;}
.veh{display:flex;align-items:stretch;border-bottom:1px solid #e2e8f0;}
.veh-img{width:220px;min-height:140px;flex-shrink:0;overflow:hidden;background:#f8fafc;}
.veh-img img{width:100%;height:100%;object-fit:cover;display:block;}
.veh-info{flex:1;padding:20px 24px;display:flex;flex-direction:column;justify-content:center;gap:6px;}
.veh-name{font-size:18px;font-weight:800;color:#0f172a;line-height:1.2;}
.veh-sub{font-size:12px;color:#64748b;font-weight:500;}
.veh-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;}
.pill{background:#f1f5f9;border-radius:6px;padding:3px 10px;font-size:11px;font-weight:600;color:#475569;}
.body{padding:28px 32px;display:grid;grid-template-columns:1fr 1fr;gap:24px;}
.section-title{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#94a3b8;margin-bottom:12px;}
.price-table{width:100%;border-collapse:collapse;}
.price-table tr td{padding:9px 0;font-size:13px;border-bottom:1px solid #f1f5f9;}
.price-table tr:last-child td{border-bottom:none;}
.price-table .lbl{color:#475569;font-weight:500;}
.price-table .amt{text-align:right;font-weight:600;color:#0f172a;}
.price-table .otd td{padding-top:13px;font-size:15px;font-weight:800;color:#0f172a;border-top:2px solid #e2e8f0;border-bottom:none;}
.price-table .down td{font-size:12px;color:#64748b;font-weight:500;}
.price-table .fin td{font-size:14px;font-weight:700;color:#1877F2;}
.payments-wrap{display:flex;flex-direction:column;gap:12px;}
.apr-note{font-size:11px;color:#94a3b8;font-weight:500;text-align:center;}
.sigs{padding:0 32px 28px;display:grid;grid-template-columns:1fr 1fr;gap:24px;}
.sig-line{border-top:1px solid #cbd5e1;padding-top:8px;font-size:11px;color:#94a3b8;font-weight:500;}
.foot{background:#f8fafc;padding:16px 32px;border-top:1px solid #e2e8f0;font-size:10px;color:#94a3b8;line-height:1.6;}
</style>
<div class="page">
  <div class="hd">
    <div class="hd-left"><h1>Grubbs INFINITI</h1><p>Pricing Worksheet</p></div>
    <div class="hd-right"><div class="badge">Mock Pencil</div><div class="date">${dateStr}</div></div>
  </div>
  <div class="veh">
    <div class="veh-img">${imgUrl ? `<img src="${imgUrl}" alt="${fullLabel}" crossorigin="anonymous"/>` : ''}</div>
    <div class="veh-info">
      <div class="veh-name">${fullLabel}</div>
      <div class="veh-sub">Stock #${stock} &nbsp;·&nbsp; ${vin}${this.pencilCustomerName ? ' &nbsp;·&nbsp; ' + this.pencilCustomerName : ''}</div>
      <div class="veh-meta">
        ${mileage !== '—' ? `<span class="pill">${mileage}</span>` : ''}
        ${color !== '—' ? `<span class="pill">${color}</span>` : ''}
        ${v.condition ? `<span class="pill" style="text-transform:capitalize">${v.condition}</span>` : ''}
      </div>
    </div>
  </div>
  <div class="body">
    <div>
      <div class="section-title">Price Breakdown</div>
      <table class="price-table">
        <tr><td class="lbl">Internet Price</td><td class="amt">${fmt(basePrice)}</td></tr>
        ${addendum > 0 ? `<tr><td class="lbl">${addendumLabel}</td><td class="amt">${fmt(addendum)}</td></tr>` : ''}
        <tr><td class="lbl">${taxLabel} (${Number(this.mockPencil.taxRate||0).toFixed(2)}%)</td><td class="amt">${fmt(taxAmount)}</td></tr>
        ${docFee > 0 ? `<tr><td class="lbl">${docFeeLabel}</td><td class="amt">${fmt(docFee)}</td></tr>` : ''}
        <tr class="otd"><td>Out-the-Door</td><td style="text-align:right">${fmt(outTheDoor)}</td></tr>
        ${downPayment > 0 ? `<tr class="down"><td>Down Payment</td><td style="text-align:right">− ${fmt(downPayment)}</td></tr>` : ''}
        ${downPayment > 0 ? `<tr class="fin"><td>Amount Financed</td><td style="text-align:right">${fmt(amountFinanced)}</td></tr>` : ''}
      </table>
    </div>
    <div class="payments-wrap">
      <div class="section-title">Monthly Payment Options</div>
      <table style="width:100%;border-collapse:separate;border-spacing:6px;">
        <tr>${pmtCols}</tr>
      </table>
      <div class="apr-note">${Number(apr).toFixed(2)}% APR · Based on ${fmt(amountFinanced)} financed${downPayment > 0 ? ` · ${fmt(downPayment)} down` : ''}</div>
    </div>
  </div>
  <div class="sigs">
    <div><div class="sig-line">Customer Signature &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date</div></div>
    <div><div class="sig-line">Sales Associate &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date</div></div>
  </div>
  <div class="foot">This worksheet is an estimate only and does not constitute a contract or commitment. Pricing, taxes, fees, and payment amounts are subject to change and contingent upon credit approval, final tax and title calculations, lender participation, and vehicle availability at time of delivery. All payments based on the APR and term shown. Actual rate may vary based on credit profile.</div>
</div>`

      const container = document.createElement('div')
      container.innerHTML = worksheetHTML
      container.style.cssText = 'position:absolute;left:-9999px;top:0;width:820px;background:#f1f5f9;'
      document.body.appendChild(container)

      const filename = `pencil-${(stock !== 'N/A' ? stock : vin).replace(/[^a-z0-9-]/gi, '_')}.pdf`
      try {
        await html2pdf().from(container).set({
          margin:     [8, 8, 8, 8],
          filename,
          image:      { type: 'jpeg', quality: 0.95 },
          html2canvas: { scale: 2, useCORS: true, logging: false },
          jsPDF:      { unit: 'mm', format: 'a4', orientation: 'portrait' },
        }).save()
      } catch(e) {
        alert('PDF generation failed. Try the browser print dialog instead (Ctrl+P).')
      } finally {
        document.body.removeChild(container)
        this.pdfGenerating = false
      }
    },

    downloadMockPencil(v) {
      if (!v?.price_ok || !v?.effective_price) {
        alert('This unit needs an internet price before generating a pencil.')
        return
      }

      const basePrice      = Number(v.effective_price)
      const addendum       = Number(this.mockPencil.addendumAmount || 0)
      const taxRate        = Number(this.mockPencil.taxRate || 0) / 100
      const taxAmount      = Number(((basePrice + addendum) * taxRate).toFixed(2))
      const docFee         = Number(this.mockPencil.docFeeAmount || 0)
      const downPayment    = Number(this.mockPencil.downPayment || 0)
      const outTheDoor     = Number((basePrice + addendum + taxAmount + docFee).toFixed(2))
      const amountFinanced = Math.max(0, outTheDoor - downPayment)
      const apr            = Number(this.mockPencil.apr || 0)

      const calcPmt = (amt, a, n) => {
        const r = a / 100 / 12
        if (r <= 0) return amt / n
        return amt * r / (1 - Math.pow(1 + r, -n))
      }
      const fmt = n => Number(n || 0).toLocaleString('en-US', { style:'currency', currency:'USD', maximumFractionDigits: 0 })
      const fmtD = n => Number(n || 0).toLocaleString('en-US', { style:'currency', currency:'USD' })

      const vehicleLabel = `${v.year || ''} ${v.make || ''} ${v.model || ''}`.trim()
      const fullLabel    = v.trim ? `${vehicleLabel} ${v.trim}` : vehicleLabel
      const stock        = v.stock_number || 'N/A'
      const vin          = v.vin || 'N/A'
      const mileage      = v.mileage ? Number(v.mileage).toLocaleString() + ' mi' : '—'
      const color        = v.exterior_color || '—'
      const dateStr      = new Date().toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' })
      const imgUrl       = v.image_url || ''

      const addendumLabel = this.mockPencil.addendumLabel || 'Addendum'
      const taxLabel      = this.mockPencil.taxLabel || 'Sales Tax'
      const docFeeLabel   = this.mockPencil.docFeeLabel || 'Doc Fee'

      const terms  = [48, 60, 72, 84]
      const pmtCols = terms.map(t => {
        const pmt = calcPmt(amountFinanced, apr, t)
        const hi  = t === 72
        return `<td style="padding:16px 12px;text-align:center;background:${hi?'#1877F2':'#f8fafc'};border-radius:10px;vertical-align:top;">
          <div style="font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:${hi?'rgba(255,255,255,.75)':'#94a3b8'};margin-bottom:6px;">${t} mo</div>
          <div style="font-size:22px;font-weight:800;color:${hi?'#fff':'#0f172a'};line-height:1;">${fmtD(pmt)}</div>
          <div style="font-size:10px;color:${hi?'rgba(255,255,255,.65)':'#94a3b8'};margin-top:4px;">per month</div>
        </td>`
      }).join('<td style="width:8px;"></td>')

      const html = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pricing Worksheet — ${fullLabel}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Inter',Arial,sans-serif;background:#f1f5f9;color:#0f172a;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
    .page{max-width:780px;margin:32px auto;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,.10);}
    /* Header */
    .hd{background:#0f172a;padding:28px 32px;display:flex;align-items:center;justify-content:space-between;}
    .hd-left h1{font-size:20px;font-weight:800;color:#fff;letter-spacing:-.01em;}
    .hd-left p{font-size:12px;color:#94a3b8;margin-top:4px;font-weight:500;letter-spacing:.04em;text-transform:uppercase;}
    .hd-right{text-align:right;}
    .hd-right .badge{display:inline-block;background:#1877F2;color:#fff;font-size:11px;font-weight:700;padding:5px 12px;border-radius:20px;letter-spacing:.04em;text-transform:uppercase;}
    .hd-right .date{font-size:11px;color:#64748b;margin-top:6px;}
    /* Vehicle strip */
    .veh{display:flex;align-items:stretch;border-bottom:1px solid #e2e8f0;}
    .veh-img{width:220px;min-height:140px;flex-shrink:0;overflow:hidden;background:#f8fafc;}
    .veh-img img{width:100%;height:100%;object-fit:cover;display:block;}
    .veh-img-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
    .veh-img-placeholder svg{opacity:.18;}
    .veh-info{flex:1;padding:20px 24px;display:flex;flex-direction:column;justify-content:center;gap:6px;}
    .veh-name{font-size:18px;font-weight:800;color:#0f172a;line-height:1.2;}
    .veh-sub{font-size:12px;color:#64748b;font-weight:500;}
    .veh-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;}
    .pill{background:#f1f5f9;border-radius:6px;padding:3px 10px;font-size:11px;font-weight:600;color:#475569;}
    /* Body */
    .body{padding:28px 32px;display:grid;grid-template-columns:1fr 1fr;gap:24px;}
    /* Pricing table */
    .section-title{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#94a3b8;margin-bottom:12px;}
    .price-table{width:100%;border-collapse:collapse;}
    .price-table tr td{padding:9px 0;font-size:13px;border-bottom:1px solid #f1f5f9;}
    .price-table tr:last-child td{border-bottom:none;}
    .price-table .lbl{color:#475569;font-weight:500;}
    .price-table .amt{text-align:right;font-weight:600;color:#0f172a;}
    .price-table .otd td{padding-top:13px;font-size:15px;font-weight:800;color:#0f172a;border-top:2px solid #e2e8f0;border-bottom:none;}
    .price-table .down td{font-size:12px;color:#64748b;font-weight:500;}
    .price-table .fin td{font-size:14px;font-weight:700;color:#1877F2;}
    /* Payment cards */
    .payments-wrap{display:flex;flex-direction:column;gap:12px;}
    .apr-note{font-size:11px;color:#94a3b8;font-weight:500;text-align:center;}
    /* Signatures */
    .sigs{padding:0 32px 28px;display:grid;grid-template-columns:1fr 1fr;gap:24px;}
    .sig-line{border-top:1px solid #cbd5e1;padding-top:8px;font-size:11px;color:#94a3b8;font-weight:500;}
    /* Footer */
    .foot{background:#f8fafc;padding:16px 32px;border-top:1px solid #e2e8f0;font-size:10px;color:#94a3b8;line-height:1.6;}
    @media print{body{background:#fff;}.page{box-shadow:none;margin:0;border-radius:0;}}
  </style>
</head>
<body>
<div class="page">

  <!-- Header -->
  <div class="hd">
    <div class="hd-left">
      <h1>Grubbs INFINITI</h1>
      <p>Pricing Worksheet</p>
    </div>
    <div class="hd-right">
      <div class="badge">Mock Pencil</div>
      <div class="date">${dateStr}</div>
    </div>
  </div>

  <!-- Vehicle strip -->
  <div class="veh">
    <div class="veh-img">
      ${imgUrl
        ? `<img src="${imgUrl}" alt="${fullLabel}" />`
        : `<div class="veh-img-placeholder"><svg width="64" height="64" viewBox="0 0 24 24" fill="#0f172a"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg></div>`
      }
    </div>
    <div class="veh-info">
      <div class="veh-name">${fullLabel}</div>
      <div class="veh-sub">Stock #${stock} &nbsp;·&nbsp; ${vin}</div>
      <div class="veh-meta">
        ${mileage !== '—' ? `<span class="pill">${mileage}</span>` : ''}
        ${color !== '—' ? `<span class="pill">${color}</span>` : ''}
        ${v.condition ? `<span class="pill" style="text-transform:capitalize">${v.condition}</span>` : ''}
      </div>
    </div>
  </div>

  <!-- Body: pricing + payments -->
  <div class="body">

    <!-- Pricing breakdown -->
    <div>
      <div class="section-title">Price Breakdown</div>
      <table class="price-table">
        <tr><td class="lbl">Internet Price</td><td class="amt">${fmt(basePrice)}</td></tr>
        ${addendum > 0 ? `<tr><td class="lbl">${addendumLabel}</td><td class="amt">${fmt(addendum)}</td></tr>` : ''}
        <tr><td class="lbl">${taxLabel} (${Number(this.mockPencil.taxRate||0).toFixed(2)}%)</td><td class="amt">${fmt(taxAmount)}</td></tr>
        ${docFee > 0 ? `<tr><td class="lbl">${docFeeLabel}</td><td class="amt">${fmt(docFee)}</td></tr>` : ''}
        <tr class="otd"><td>Out-the-Door</td><td style="text-align:right">${fmt(outTheDoor)}</td></tr>
        ${downPayment > 0 ? `<tr class="down"><td>Down Payment</td><td style="text-align:right">− ${fmt(downPayment)}</td></tr>` : ''}
        ${downPayment > 0 ? `<tr class="fin"><td>Amount Financed</td><td style="text-align:right">${fmt(amountFinanced)}</td></tr>` : ''}
      </table>
    </div>

    <!-- Payment options -->
    <div class="payments-wrap">
      <div class="section-title">Monthly Payment Options</div>
      <table style="width:100%;border-collapse:separate;border-spacing:6px;">
        <tr>${pmtCols}</tr>
      </table>
      <div class="apr-note">${Number(apr).toFixed(2)}% APR · Based on ${fmt(amountFinanced)} financed${downPayment > 0 ? ` · ${fmt(downPayment)} down` : ''}</div>
    </div>

  </div>

  <!-- Signature lines -->
  <div class="sigs">
    <div>
      <div class="sig-line">Customer Signature &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date</div>
    </div>
    <div>
      <div class="sig-line">Sales Associate &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date</div>
    </div>
  </div>

  <!-- Footer -->
  <div class="foot">
    This worksheet is an estimate only and does not constitute a contract or commitment. Pricing, taxes, fees, and payment amounts are subject to change and contingent upon credit approval, final tax and title calculations, lender participation, and vehicle availability at time of delivery. All payments based on the APR and term shown. Actual rate may vary based on credit profile.
  </div>

</div>
</body>
</html>`

      const blob = new Blob([html], { type: 'text/html' })
      const url  = URL.createObjectURL(blob)
      const a    = document.createElement('a')
      a.href     = url
      a.download = `pencil-${(stock !== 'N/A' ? stock : vin).replace(/[^a-z0-9-]/gi, '_')}.html`
      a.click()
      URL.revokeObjectURL(url)
    },

    fmtBig(n) {
      if (!n) return '0'
      if (n >= 1000000) return (n/1000000).toFixed(1) + 'M'
      if (n >= 1000) return (n/1000).toFixed(1) + 'K'
      return String(n)
    },

    fmtDate(iso) {
      if (!iso) return '—'
      try {
        return new Date(iso.endsWith('Z') ? iso : iso + 'Z')
          .toLocaleString('en-US', { month:'short', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit' })
      } catch { return iso }
    },

    bodyBadge(bs) {
      const map = {
        SUV: 'bg-blue-100 text-blue-700', TRUCK: 'bg-orange-100 text-orange-700',
        SEDAN: 'bg-slate-100 text-slate-700', COUPE: 'bg-purple-100 text-purple-700',
        CONVERTIBLE: 'bg-pink-100 text-pink-700', HATCHBACK: 'bg-teal-100 text-teal-700',
        MINIVAN: 'bg-yellow-100 text-yellow-700', WAGON: 'bg-green-100 text-green-700',
        CROSSOVER: 'bg-cyan-100 text-cyan-700',
      }
      return map[bs] || 'bg-slate-100 text-slate-500'
    },

    drawCharts() {
      const COLORS = ['#1877F2','#8B5CF6','#10B981','#F59E0B','#EF4444','#06B6D4','#EC4899','#6366F1','#14B8A6']

      // Make chart
      const makes  = Object.entries(this.summary.makes_breakdown || {})
      const mc = document.getElementById('makeChart')
      if (mc) {
        if (mc._chart) mc._chart.destroy()
        mc._chart = new Chart(mc, {
          type: 'doughnut',
          data: { labels: makes.map(x=>x[0]), datasets:[{ data: makes.map(x=>x[1]), backgroundColor: COLORS, borderWidth:2, borderColor:'#fff' }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
        })
      }

      // Body style chart
      const bodies = Object.entries(this.summary.body_breakdown || {})
      const bc = document.getElementById('bodyChart')
      if (bc) {
        if (bc._chart) bc._chart.destroy()
        bc._chart = new Chart(bc, {
          type: 'doughnut',
          data: { labels: bodies.map(x=>x[0]), datasets:[{ data: bodies.map(x=>x[1]), backgroundColor: COLORS, borderWidth:2, borderColor:'#fff' }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
        })
      }

      // Year bar chart
      const years = Object.entries(this.summary.years_breakdown || {}).reverse()
      const yc = document.getElementById('yearChart')
      if (yc) {
        if (yc._chart) yc._chart.destroy()
        yc._chart = new Chart(yc, {
          type: 'bar',
          data: { labels: years.map(x=>x[0]), datasets:[{ label:'Vehicles', data: years.map(x=>x[1]), backgroundColor:'#1877F2', borderRadius:4 }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0, font:{ size:10 } } }, x:{ ticks:{ font:{ size:10 } } } } }
        })
      }

      // Price histogram
      const prices = this.vehicles.map(v=>v.price_dollars).filter(Boolean)
      const pc = document.getElementById('priceChart')
      if (pc && prices.length) {
        const min = Math.floor(Math.min(...prices)/5000)*5000
        const max = Math.ceil(Math.max(...prices)/5000)*5000
        const buckets = {}
        for (let b = min; b <= max; b += 5000) buckets[b] = 0
        prices.forEach(p => { const b = Math.floor(p/5000)*5000; if (b in buckets) buckets[b]++ })
        const labels = Object.keys(buckets).map(k=>'$'+Number(k).toLocaleString())
        const data   = Object.values(buckets)
        if (pc._chart) pc._chart.destroy()
        pc._chart = new Chart(pc, {
          type: 'bar',
          data: { labels, datasets:[{ label:'Vehicles', data, backgroundColor:'#10B981', borderRadius:4 }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0, font:{ size:9 } } }, x:{ ticks:{ font:{ size:9 }, maxRotation:45 } } } }
        })
      }
    },

    // Re-draw when switching to analytics
    $watch_tab(val) {
      if (val === 'analytics') this.$nextTick(() => this.drawCharts())
    },
  }
}
</script>

</body>
</html>
